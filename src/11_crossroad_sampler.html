<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Crossroad Sampler</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
    .toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
      font-size: 13px;
    }
    .toolbar button { margin-right: 6px; }
    html.embed .toolbar { display: none; }

    /* ===== 枝先番号（5倍級） ===== */
    .branch-no-label{
      width: 140px;
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 100px;
      font-weight: 900;
      color: #111;
      text-shadow: 3px 3px 8px rgba(255,255,255,0.98);
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      padding: 0 !important;
      line-height: 1.0;
    }
    .leaflet-tooltip.branch-no-label::before{
      display: none !important;
    }

  </style>

  <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
</head>

<body>
  <div id="map"></div>

  <div class="toolbar">
    <div><strong>交差点ID: 001</strong></div>
    <div style="margin-top:4px;">
      出力ファイル名：
      <input id="outputName" type="text"
             value="crossroad001"
             style="width: 140px;" />
    </div>
    <div style="margin-top:4px;">
      <button onclick="saveCsv()">保存</button>
      <button onclick="clearAll()">全消去</button>
    </div>
    <div style="margin-top:4px;">左クリック：中心 / 方向追加　右クリック：方向削除</div>
  </div>

  <script>
    if (new URLSearchParams(location.search).get("embed") === "1") {
      document.documentElement.classList.add("embed");
    }

    let bridge = null;
    function setupBridge() {
      if (typeof QWebChannel === "undefined" || !window.qt || !qt.webChannelTransport) {
        return;
      }
      new QWebChannel(qt.webChannelTransport, function(channel) {
        bridge = channel.objects.bridge;
        if (bridge && bridge.jsReady) {
          bridge.jsReady();
        }
      });
    }

    var map = L.map('map', { preferCanvas: true }).setView([35.069095, 134.004512], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var centerMarker = null;
    var centerLatLng = null;
    var CENTER_RING_RADIUS_PX = 18;
    var branchPoints = [];
    var branchLabels = [];
    var branchLines = [];
    var canvasRenderer = L.canvas();

    // 左クリック
    map.on('click', function(e) {
      if (!centerMarker) {
        centerLatLng = e.latlng;
        centerMarker = L.circleMarker(e.latlng, {
          radius: CENTER_RING_RADIUS_PX,
          color: "#ff0000",
          weight: 6,
          fill: true,
          fillColor: "#ff0000",
          fillOpacity: 0.0
        }).addTo(map);
      } else {
        // ===== 枝追加 =====
        var no = branchPoints.length + 1;

        // 枝先座標を保存（CSVのdir_deg算出に使う）
        branchPoints.push(e.latlng);

        // --- 青線：中心リングの内側は描かず、リング外周から描く（px計算） ---
        var pCenter = map.latLngToLayerPoint(centerLatLng);
        var pEnd = map.latLngToLayerPoint(e.latlng);

        var vx = pEnd.x - pCenter.x;
        var vy = pEnd.y - pCenter.y;
        var vlen = Math.sqrt(vx*vx + vy*vy);
        if (vlen === 0) vlen = 1;
        vx /= vlen;
        vy /= vlen;

        // リング外周の開始点（中心から半径分だけ外）
        var pStart = L.point(
          pCenter.x + vx * CENTER_RING_RADIUS_PX,
          pCenter.y + vy * CENTER_RING_RADIUS_PX
        );

        var startLatLng = map.layerPointToLatLng(pStart);

        // 線を描画（リング外から枝先まで）
        var poly = L.polyline([startLatLng, e.latlng], { weight: 4, renderer: canvasRenderer }).addTo(map);
        branchLines.push(poly);

        // --- 数字：枝方向のさらに外側へ（中心→枝先方向へpush） ---
        var pushPx = 110;
        var pLabel = L.point(pEnd.x + vx * pushPx, pEnd.y + vy * pushPx);
        var labelLatLng = map.layerPointToLatLng(pLabel);

        // 数字ラベルは「中心基準（iconAnchor中央）」で置く
        var labelW = 140, labelH = 140;

        var labelIcon = L.divIcon({
          className: "",
          html: `<div class="branch-no-label">${no}</div>`,
          iconSize: [labelW, labelH],
          iconAnchor: [Math.round(labelW/2), Math.round(labelH/2)]
        });

        var lm = L.marker(labelLatLng, { icon: labelIcon, interactive: false, keyboard: false }).addTo(map);
        branchLabels.push(lm);
      }
    });

    // 右クリックで直前削除
    map.on('contextmenu', function(e) {
      if (branchPoints.length > 0) {
        branchPoints.pop();

        var lm = branchLabels.pop();
        if (lm) map.removeLayer(lm);

        var ln = branchLines.pop();
        if (ln) map.removeLayer(ln);
      }
    });

    // 方位角計算
    function bearing(lat1, lon1, lat2, lon2) {
      let toRad = d => d * Math.PI / 180;
      let toDeg = r => r * 180 / Math.PI;

      let φ1 = toRad(lat1);
      let φ2 = toRad(lat2);
      let λ = toRad(lon2 - lon1);

      let x = Math.sin(λ) * Math.cos(φ2);
      let y = Math.cos(φ1) * Math.sin(φ2) -
              Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ);

      let θ = Math.atan2(x, y);
      return (toDeg(θ) + 360) % 360;
    }

    // 地図のスクリーンキャプチャを JPG で保存
    function saveMapJpg(baseName) {
      var mapDiv = document.getElementById("map");
      if (!window.html2canvas) {
        console.error('html2canvas が見つかりません');
        return;
      }
      if (!mapDiv) {
        console.error('#map 要素が見つかりません');
        return;
      }

      html2canvas(mapDiv, { useCORS: true, backgroundColor: null, logging: false }).then(function(canvas) {
        canvas.toBlob(function(blob) {
          if (!blob) {
            console.error('Canvas から Blob を生成できませんでした');
            return;
          }
          var urlImg = URL.createObjectURL(blob);
          var aImg = document.createElement("a");
          aImg.href = urlImg;
          aImg.download = baseName + ".jpg";
          document.body.appendChild(aImg);
          aImg.click();
          document.body.removeChild(aImg);
          URL.revokeObjectURL(urlImg);
        }, "image/jpeg", 0.9);
      }).catch(function(err) {
        console.error('地図キャプチャ中にエラーが発生しました', err);
      });
    }

    function buildCsvText() {
      let rows = ["crossroad_id,center_lon,center_lat,branch_no,branch_name,dir_deg"];
      let lon = centerLatLng.lng.toFixed(8);
      let lat = centerLatLng.lat.toFixed(8);

      for (let i = 0; i < branchPoints.length; i++) {
        let p = branchPoints[i];
        let deg = bearing(centerLatLng.lat, centerLatLng.lng, p.lat, p.lng).toFixed(2);
        rows.push("001," + lon + "," + lat + "," + (i + 1) + ",," + deg);
      }
      return rows.join("\r\n");
    }

    function beginSaveFromPy(baseName) {
      if (!centerLatLng) {
        alert("先に中心を指定してください");
        return;
      }
      if (branchPoints.length === 0) {
        alert("方向を追加してください");
        return;
      }

      if (!bridge || !bridge.requestSave) {
        alert("ブリッジ未接続");
        return;
      }

      var mapDiv = document.getElementById("map");
      if (!window.html2canvas || !mapDiv) {
        alert("画像の生成に失敗しました");
        return;
      }

      html2canvas(mapDiv, { useCORS: true, backgroundColor: null, logging: false }).then(function(canvas) {
        const jpgDataUrl = canvas.toDataURL("image/jpeg", 0.9);
        const payload = {
          base_name: baseName,
          csv_text: buildCsvText(),
          jpg_data_url: jpgDataUrl
        };
        bridge.requestSave(JSON.stringify(payload));
      }).catch(function(err) {
        console.error('地図キャプチャ中にエラーが発生しました', err);
        alert("画像の生成に失敗しました");
      });
    }

    // CSV保存
    function saveCsv() {
      if (!centerLatLng) {
        alert("先に中心を指定してください");
        return;
      }
      if (branchPoints.length === 0) {
        alert("方向を追加してください");
        return;
      }

      var nameInput = document.getElementById("outputName");
      var baseName = (nameInput && nameInput.value.trim()) || "crossroad001";

      let csvText = buildCsvText();

      let blob = new Blob([csvText], { type: "text/csv" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = baseName + ".csv";
      a.click();
      URL.revokeObjectURL(url);

      saveMapJpg(baseName);
    }

    // 全消去
    function clearAll() {
      if (centerMarker) {
        map.removeLayer(centerMarker);
        centerMarker = null;
      }
      centerLatLng = null;

      for (let l of branchLabels) map.removeLayer(l);
      for (let l of branchLines) map.removeLayer(l);

      branchPoints = [];
      branchLabels = [];
      branchLines = [];
    }

    document.addEventListener("DOMContentLoaded", setupBridge);
  </script>
</body>
</html>
