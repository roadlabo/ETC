# 06_route_mapper_kp
## 目的（何をする）
トリップ/ルート CSV を可視化しつつ、距離累計（KP）を地図上にラベル表示する。等間隔での KP 目印を付け、抽出区間の長さや位置合わせを確認する。
## 位置づけ（分析フロー上のどこ）
- **ビューア / 設定ファイル確認**フェーズ。
- 第1/第2スクリーニング後の様式1-2 出力やサンプルルートを距離スケール付きで確認する際に使用。
## 入力
- CSV（既定で `*.csv`。コマンド引数でパターン指定可）。
- 列前提（0 始まり）: 経度=15, 緯度=14, FLAG=12, TYPE=4, USE=5, GPS時刻=6, 速度=18。
## 出力
- `map_kp.html` を生成し、一度だけブラウザで開く（以降は同タブ更新）。
- KP ラベルは `KP_INTERVAL` ごとに付与（既定: 5 点ごと）、フォント/余白はスクリプト先頭の定数で調整。
## 実行方法
- コマンド例: `python 06_route_mapper_kp.py` → フォルダ選択 → CSV 選択。
- パターン指定: `python 06_route_mapper_kp.py "out/*.csv"`。
## 判定ロジック（重要なものだけ）
- 緯度経度を numpy で差分計算し、ハバーシン距離から区間距離 `d_km` と累積距離 `kp_km` を算出。
- FLAG を用いて区切りを判定し、区間ごとにポリラインを描画。
- KP ラベルは DivIcon で地図上に重ね、S/G マーカーと併用。
## できること / できないこと（行政向けの注意）
- できること: 区間距離と経路形状を同時に確認、ルート長と抽出結果のズレ検知、KP 表示付きの図を報告資料に貼付。
- できないこと: 正式な距離計算（測地系補正なしの近似）、速度統計の計算、FLAG の再計算。KP は表示専用であり、測量精度を保証しない。
## よくあるミス
- 列順誤りで距離計算が NaN になり、KP が表示されない。
- `KP_INTERVAL` を大きくし過ぎてラベルが欠落、または小さすぎて読めなくなる。
- 日本国外の座標が含まれてフィルタで落ち、表示件数がゼロになる。
## 関連スクリプト
- 前段: [docs/10_route_sampler.md](./10_route_sampler.md)（ルート作成） / [docs/20_route_trip_extractor.md](./20_route_trip_extractor.md)（抽出結果確認）。
- 後段: なし（ビューア）。
- 兄弟ツール: [docs/05_route_mapper_simple.md](./05_route_mapper_simple.md)。
- フロー全体: [docs/01_pipeline.md](./01_pipeline.md)
