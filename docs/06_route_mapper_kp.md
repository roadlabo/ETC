# 06_route_mapper_kp（距離軸生成付きルートビューア）

## このスクリプトは何をしているか

CSVに入っている走行点（緯度・経度の集合）から、
「先頭点からの累積距離（KP）」を計算し、
距離軸を持ったデータに変換します。

そのうえで、

・地図に軌跡を表示  
・一定間隔で KP ラベルを表示  

します。

---

## なぜこの処理が必要か

ETC2.0データは、

・一定距離ごとに取得されたデータではない  
・一定時間間隔でもない  
・点の数もトリップごとに異なる  

つまり「距離軸を持っていないデータ」です。

このままでは、

・距離に対する速度変化  
・区間ごとの平均速度  
・ボトルネック位置の定量評価  

ができません。

そこで本スクリプトでは、

> 緯度経度から距離を計算し、累積距離（KP）を生成する

処理を行っています。

これが後続の「ルートパフォーマンス算出」の基礎になります。

---

## 入力データ（前提）

列番号固定（0始まり）で読み込みます。

経度：15  
緯度：14  
FLAG：12  
TYPE：4  
USE：5  
GPS時刻：6  
速度：18  

※列順が違うCSVでは正しく動きません。

---

## 内部処理の流れ

### 1. CSVを読み込む

必要な列だけを読み込みます。
数値に変換できない値は除外します。

さらに、

・緯度経度が日本範囲外のものを除外  
・緯度経度が逆になっている場合は入れ替え  

を行います。

---

### 2. 点間距離を計算する

連続する2点間の距離を、
ハバーシン距離で計算します。

距離単位は km です。

---

### 3. 累積距離（KP）を計算する

先頭点を 0km とし、

KP = 各点間距離の累積和

で求めます。

重要：

・FLAG=0 や FLAG=1 ではリセットしません  
・CSV内の行順に単純累積します  

つまり、

このKPは「ファイル全体の距離軸」です。

---

### 4. 地図に表示する

・FLAG=0 → Start（S）  
・FLAG=1 → Goal（G）  
・その他 → 通過点  

として描画します。

さらに、

一定点間隔（KP_INTERVAL）ごとに

KP〇〇km

のラベルを地図上に重ねます。

---

## 出力

スクリプトと同じ場所に

map_kp.html

を生成します。

初回は新規タブ、
2回目以降は同じタブを更新します。

---

## このスクリプトの役割（機能的説明）

この06は、

「地図表示ツール」ではありません。

役割は、

> 不定間隔・不定数のETC2.0点群に距離軸を与えること

です。

この距離軸があることで、

・距離ごとの速度分布  
・区間別平均速度  
・ボトルネック位置の定量評価  

が可能になります。

後続のルートパフォーマンス計算は、
このKPを前提にしています。

---

## 注意事項

・距離はハバーシン近似（球面距離）  
・測量精度ではない  
・FLAGでは距離を分割しない  
・CSV列順が前提と違うと誤動作  
