# 33_branch_check.py 完成版マニュアル

## 1. 目的
`33_branch_check.py` は、`31_crossroad_trip_performance.py` の出力 `*_performance.csv` を読み込み、
- 枝判定（`流入枝番` / `流出枝番`）
- 角度差（`流入角度差(deg)` / `流出角度差(deg)`）
- 所要時間算出可否（`所要時間算出可否` / `所要時間算出不可理由`）
を地図と表で目視検証するための GUI ツールです。

本ツールは確定集計用途ではなく、品質確認用途です。

---

## 2. 起動方法

```bash
python src/33_branch_check.py
```

CSV を指定して起動する場合:
```bash
python src/33_branch_check.py --csv /path/to/xxx_performance.csv
```

---

## 3. 入力仕様

### 3.1 対象CSV
- `*_performance.csv`（31工程の出力）
- 文字コードは `cp932 -> shift_jis -> utf-8` の順で読込試行

### 3.2 必須列（CSV正式名称）
以下が無いと起動エラーになります。
- `交差点ファイル名`
- `運行日`
- `曜日`
- `自動車の種別`
- `用途`
- `流入枝番`
- `流出枝番`
- `流入角度差(deg)`
- `流出角度差(deg)`
- `角度算出方式`
- `計測距離(m)`
- `所要時間(s)`
- `計測開始_経度(補間)`
- `計測開始_緯度(補間)`
- `計測終了_経度(補間)`
- `計測終了_緯度(補間)`
- `交差点中心_経度`
- `交差点中心_緯度`
- `算出中心_経度`
- `算出中心_緯度`

### 3.3 Point CSV（任意）
`11_交差点(Point)データ` から同名交差点 CSV を自動探索します。
- 例: `03abc_performance.csv` -> `11_交差点(Point)データ/03abc.csv`

読み込めた場合、基準枝レイを Point CSV 定義から描画します。

---

## 4. 画面構成

- 左ペイン: トリップ一覧テーブル
- 右上: 地図（Leaflet）
- 右下: 詳細情報パネル

行選択（マウス/キーボード）で右側表示が更新されます。

---

## 5. 表示レイヤ構造（地図）

本ツールは地図上で次のレイヤ構造を使います。

1. **ベースレイヤ**
   - OpenStreetMap タイル
2. **枝レイヤ（`branchLayer`）**
   - 基準枝レイ（破線）
   - 枝番号ラベル
   - Point CSV 由来の場合は `source=point` スタイル（赤系）
3. **トリップレイヤ（`tripLayer`）**
   - 指定中心マーカー（赤）
   - 算出中心マーカー
   - 計測開始→算出中心→計測終了の2区間線
   - 計測開始/終了マーカー
   - RAW点列オーバーレイ（`point-4`〜`point+4` がある場合）
   - IN/OUT 角度レイ + ラベル（枝番・角度差）
   - アニメーションマーカー（開始→中心→終了を往復）

---

## 6. 表示項目

### 6.1 一覧テーブル主要列
- `運行日`
- `曜日`
- `運行ID`
- `トリップID`
- `自動車の種別`
- `用途`
- `所要時間算出可否`
- `遅れ時間(s)`
- `流入枝番`
- `流出枝番`
- `流入角度差(deg)`
- `流出角度差(deg)`

### 6.2 詳細パネル主要項目
- `交差点ファイル名`
- `運行日`
- `曜日`
- `自動車の種別`
- `用途`
- `所要時間(s)`
- `閑散時所要時間(s)`
- `遅れ時間(s)`
- `所要時間算出可否`
- `所要時間算出不可理由`
- `流入枝番`
- `流出枝番`
- `流入角度差(deg)`
- `流出角度差(deg)`
- `角度算出方式`
- `計測距離(m)`
- `【中央】GPS時刻`

---

## 7. 時間系の扱い（時間算出）

このツールは時間を再計算せず、`*_performance.csv` の結果を表示します。

- `所要時間(s)`
- `閑散時所要時間(s)`
- `遅れ時間(s)`
- `所要時間算出可否`
- `所要時間算出不可理由`

加えて、`交差点通過速度(km/h)` 列が入力CSVに無い場合は内部で補完計算します。
- 計算式: `計測距離(m) / 所要時間(s) * 3.6`
- 有効条件: 距離>0 かつ 所要時間>0

---

## 8. 角度系の扱い（角度算出）

このツールは角度を再判定せず、CSV列を可視化します。
- `流入角度deg`
- `流出角度deg`
- `流入角度差(deg)`
- `流出角度差(deg)`
- `流入枝番`
- `流出枝番`

地図上では、`算出中心` から
- IN レイ（`流入角度deg`）
- OUT レイ（`流出角度deg`）
を描画し、ラベルに枝番と角度差を表示します。

---

## 9. 並び順と強調表示
- トリップは原則「算出可否優先 + 遅れ時間降順 + 運行日昇順」で整列します。
- 一覧では `流入角度差(deg)` / `流出角度差(deg)` が 45° 以上のセルを黄色強調します。

---

## 10. 後方互換の挙動

### 10.1 Point CSV 列名互換
Point CSV の列名が統一されていなくても、以下の候補で吸収します。
- 中心緯度候補: `中心_緯度`, `中心緯度`, `lat`, `緯度`, `交差点中心_緯度`, `center_lat`
- 中心経度候補: `中心_経度`, `中心経度`, `lon`, `経度`, `交差点中心_経度`, `center_lon`
- 枝番候補: `枝番`, `branch`, `branch_no`, `No`, `番号`
- 角度候補: `角度`, `方位角`, `bearing`, `azimuth`, `F列`, `angle_deg`, `dir_deg`
- ベクトル候補: `dx`/`dy`, `東西(m)`/`南北(m)` ほか

### 10.2 基準枝のフォールバック
- Point CSV が見つからない/読めない/枝方向が作れない場合、`基準枝なしモード` で起動します。
- このとき `*_performance.csv` の `計測開始_経度(補間)` / `計測開始_緯度(補間)` と `流入枝番` から代表方向を推定し、枝レイを近似生成します。

### 10.3 互換的な角度解釈
- Point CSV の角度列が `dir_deg` / `bearing` / `azimuth` / `方位角` 系の場合、方位角系として内部換算して描画します。

---

## 11. 注意事項
- OSMタイル取得のためネットワーク接続が必要です。
- 本ツールは検証用 GUI です。最終確定値は `*_performance.csv` およびレポート工程で確認してください。
