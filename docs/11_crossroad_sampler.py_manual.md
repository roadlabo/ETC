# 11_crossroad_sampler.py 説明書（Markdown版）

交差点の中心点と枝方向を、ブラウザ上の地図クリックだけで作成し、CSV と HTML を同時に得られるツールです。Python 側は標準ライブラリのみを使い、実行すると HTML を生成してブラウザで開きます。保存ボタンから `crossroadXXX.csv` をその場でダウンロードでき、同じベース名で地図のスクリーンショット（JPG）も保存されます。

---

## 1. 機能一覧
- 交差点 ID ごとに HTML を生成（例: `crossroad001.html`）。
- 地図をクリックして **中心点** と **方向（枝）** を追加。
- 方位角を自動計算し、番号付きツールチップで方向を表示。
- ツールバーで **出力ファイル名** を指定可能（拡張子は自動付与）。
- **保存** ボタンで CSV をダウンロードし、同じベース名の JPG スクリーンショットも取得。**全消去** ボタンでリセット。
- 右クリックで直前の枝を取り消し。

---

## 2. 必要ファイル / ライブラリ
- Python 標準ライブラリのみ使用（追加インストール不要）。
- ブラウザで Leaflet（CDN から読み込み）を利用。

---

## 3. 出力されるファイル
### 3-1. crossroadXXX.html
- `src/11_crossroad_sampler.py` を実行すると `src/crossroads/crossroadXXX.html` を生成し、ブラウザで自動オープンします。
- HTML 内でクリック操作を行い、保存ボタンで CSV を取得します。

### 3-2. {ファイル名}.csv
保存ボタン押下時にブラウザからダウンロードされます（ツールバーの出力ファイル名 + `.csv`。未入力時は `crossroad{ID}.csv`）。フォー
マットは次の通りです。

| crossroad_id | center_lon | center_lat | branch_no | branch_name | dir_deg |
|--------------|------------|------------|-----------|-------------|---------|
| 001 | 134.00012345 | 35.12345678 | 1 |  | 350.00 |
| 001 | 134.00012345 | 35.12345678 | 2 |  | 85.12 |

- **branch_no**: 追加順の番号（1 から）
- **dir_deg**: 中心→枝の方位角（北=0°, 時計回り）

### 3-3. {ファイル名}.jpg
- 保存ボタン押下時に、ブラウザで見えている地図領域を JPG 画像としてダウンロードします（出力ファイル名 + `.jpg`）。
- 交差点中心と枝の線・番号が画像に含まれ、記録・資料用の静止画として利用できます。
- ネットワークやブラウザの制約で背景タイルが欠ける場合がありますが、その際も中心・方向の描画は画像に残ります。

---

## 4. 使い方（操作手順）
### 4-1. 実行コマンド
```bash
python src/11_crossroad_sampler.py
```

スクリプト冒頭の設定値を編集して、交差点 ID や初期表示位置を変更します。

### 4-2. 地図上での操作
1. **最初の左クリック**: 交差点の中心を設定（マーカーが表示されます）。
2. **以降の左クリック**: 枝方向を追加。中心から枝までの線と番号付きツールチップが描画されます。
3. **右クリック**: 直前に追加した枝を 1 本ずつ削除。
4. **保存ボタン**: 現在の中心・枝情報を CSV としてダウンロードし、同じベース名で地図の JPG スクリーンショットも保存。
5. **全消去ボタン**: 中心・枝をすべてリセットしてやり直し。

補足:
- 中心点マーカーのポップアップ表示は "Centre" です（中心には枝番号は付きません）。
- ツールバーの「出力ファイル名」入力欄に拡張子なしで任意名を入力できます。空欄の場合は `crossroad{ID}` が使われ、`{ファイル名}.csv` と
  `{ファイル名}.jpg` の 2 つが保存されます。

---

## 5. 方位角の計算方法
中心点と枝の座標から次の式で方位角を算出し、0〜360° に正規化して `dir_deg` に出力します。

```
bearing = atan2(Δlon, Δlat)  # 北=0°, 東=90°, 時計回り
```

---

## 6. トラブルシューティング
- **保存できない**: 中心または枝が未指定の場合、警告が出ます。順に指定してください。
- **地図が表示されない**: オフライン環境ではタイルが読み込めません。ネットワーク接続を確認してください。
- **CSV の文字化け**: 文字コードは UTF-8 です。対応したエディタで開いてください。

---

## 7. 交差点 ID の運用例
- `crossroad001.html` と `crossroad001.csv` のペアで 1 交差点を管理。
- `CROSSROAD_ID` を変えて再実行すれば、別の交差点用 HTML/CSV を作成できます。

---

## 8. まとめ
- 実行するだけでブラウザ上に編集ツールを生成。
- クリック操作のみで中心と枝を直感的に入力。
- 保存ボタンから即座に CSV を取得でき、後続の処理に渡しやすい構造になっています。
