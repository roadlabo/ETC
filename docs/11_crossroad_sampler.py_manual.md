# 11_crossroad_sampler.py 説明書（Markdown版）

交差点の中心点と、そこから伸びる 3〜5 本の道路方向（アプローチ方向）を、地図上のクリック操作だけで設定できるツールです。設定結果は **CSV** と **HTML** の 2 形式で出力され、後段の `16_crossroad_extractor.py` が進入方向・退出方向を判定するための入力として利用します。

---

## 1. 機能一覧
- 地図上をクリックして **交差点中心** を指定
- 続けて 3〜5 回クリックして **道路方向** を指定
- クリックした中心点と方向点から **方位角（北=0° / 時計回り）を自動計算**
- 指定内容を **CSV + HTML** で保存
- HTML では **矢印と番号ラベル** で方向を可視化
- 交差点 ID ごとに複数ファイルを管理でき、再利用も容易

---

## 2. 必要ファイル / ライブラリ
Python 標準ライブラリに加え、次を利用します。

- folium（地図表示）
- Flask（ローカル Web UI 提供）

依存ライブラリのインストール例（venv 利用を推奨）：
```bash
pip install folium flask
```

---

## 3. 出力されるファイル
### 3-1. crossroadXXX.csv
交差点方向情報をまとめた構造化データです（XXX は 3 桁の交差点 ID 例：001, 002）。

想定フォーマット例：

| crossroad_id | center_lon | center_lat | branch_no | branch_name | dir_deg |
|--------------|------------|------------|-----------|-------------|---------|
| 001 | 134.000123 | 35.123456 | 1 | 北側アプローチ | 350.0 |
| 001 | 134.000123 | 35.123456 | 2 | 東側アプローチ | 85.0 |
| 001 | 134.000123 | 35.123456 | 3 | 南側アプローチ | 190.2 |

- **branch_no**: 方向番号（1〜5）
- **dir_deg**: 中心→方向点ベクトルの方位角（北=0°, 東=90°, 時計回り）

### 3-2. crossroadXXX.html
Folium で生成するインタラクティブ地図です。

- 中心点：赤い大きめマーカーで表示
- 各方向：太い矢印で描画し、近くに branch_no ラベルを表示

---

## 4. 使い方（操作手順）
### 4-1. 実行コマンド
```bash
python 11_crossroad_sampler.py --id 001
```

主なオプション例：
- `--id` : 交差点番号（3 桁推奨）
- `--center-lat` / `--center-lon` : 初期表示の中心位置（省略可）
- `--output-dir` : CSV/HTML の出力先（デフォルトはカレントディレクトリ）
- `--open-browser` : サーバー起動後に既定ブラウザを自動で開く

例：
```bash
python 11_crossroad_sampler.py --id 003 --center-lat 35.12 --center-lon 134.01
```

### 4-2. 地図を使った方向指定
1. **最初のクリック**：交差点の中心点を指定（事前に座標指定した場合はスキップ可）
2. **続けて 3〜5 回クリック**：道路方向の端点を指定（中心から離れた位置を方向に向けてクリック）
3. 追加済みの枝は画面上部のリストに **枝番号 / 任意ラベル / 緯度・経度（小数第5位まで）** として表示され、Undo/Reset ボタンで調整可能
4. 保存ボタンで `crossroadXXX.csv` と `crossroadXXX.html` を出力。枝本数が 3〜5 本でない場合はステータス欄に赤字で警告が出る

---

## 5. 方向の計算方法（技術メモ）
クリックされた中心点と方向点からベクトルを作り、次の式で方位角を求めます。

```
angle_deg = atan2(Δlon, Δlat)  # 北=0°、東=90°方向
```

必要に応じて 0〜360° の範囲に正規化した値を `dir_deg` として記録します。この値が `16_crossroad_extractor.py` の進入方向・退出方向マッチングで利用されます。UI では保存前に枝リストとステータス欄で本数・座標を確認できるため、角度計算の元となる位置指定ミスを抑制できます。

---

## 6. トラブルシューティング
- **HTML が真っ白**：Folium の JS がブロックされている可能性。別ブラウザで開く。
- **方位角が逆に見える**：方向指定のクリックは必ず「中心 → 道路方向」に向けて行う。
- **クリックが反応しない**：ページを再読み込みしてやり直す。

---

## 7. 交差点 ID の運用例
- `crossroad001.csv`, `crossroad002.csv` ... のように ID を付けて管理することで複数交差点に対応。
- `16_crossroad_extractor.py` で複数交差点に順次適用できる設計を想定。

---

## 8. まとめ
- 地図をクリックするだけで交差点の形状情報を直感的に作成
- CSV + HTML の二重出力で確認しやすい
- 方位角データを自動計算し、交通量解析・ETC2.0 解析の精度向上に役立つ
