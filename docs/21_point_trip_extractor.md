# 21_point_trip_extractor

## 1. このスクリプトは何をしているか（ひとことで）

**「交差点の中心点から一定距離以内を通過したトリップ区間だけを抽出する」**。

第1スクリーニング済みのトリップCSVから、指定した交差点中心点の近傍を通った区間を自動抽出します。

## 2. 全体の流れ（処理フロー）

処理は以下の順番で行われます。

1. 入力トリップCSVを読み込む
2. トリップを区間（セグメント）に分割する
3. 各区間が交差点中心から一定距離以内か判定する
4. ヒットした区間を新しいCSVとして保存する

## 3. 入力データ

### (A) トリップCSV

列位置は固定で読み込まれます。

| 内容 | 列番号 |
|---|---|
| 経度 | 14列目 |
| 緯度 | 15列目 |
| FLAG | 12列目 |
| GPS時刻 | 6列目 |
| 運行日 | 2列目 |
| 運行ID | 3列目 |
| 車種 | 4列目 |
| 用途 | 5列目 |
| TRIP_NO | 8列目 |

### (B) 交差点CSV

`11_交差点(Point)データ` フォルダ内のCSVを読み込みます。

使用するのは**最初の1行目の座標のみ**です。

- 列1: 経度
- 列2: 緯度

ファイル名（stem）が交差点名になります。

例:

- `01nomura.csv` → 交差点名 = `01nomura`

## 4. セグメント（区間）の作り方

トリップは1つの連続データではなく、`FLAG` と `TRIP_NO` で分割されます。

### 分割条件

- `FLAG` が `0` → その行から新しい区間
- `FLAG` が `1` → その次の行から新しい区間
- `TRIP_NO` が変わったとき → 区間分割

これにより、`[start, end)` という複数の候補区間が生成されます。

## 5. 判定の核心（どんな計算をしているか）

交差点通過判定は**2段階構造**です。

### ① 点判定（まずは単純距離）

各GPS点についてハバーサイン距離を計算します。

- 地球半径: `6,371,000m`
- 緯度経度をラジアン変換し、球面三角法で距離算出

判定条件:

- `THRESH_M = 20m`

交差点中心から20m以内の点があればヒットします。

### ② 線分判定（すり抜け補正）

GPSが交差点中心をまたいだが、どの点も20m以内に入らなかった場合の補正です。

手順:

1. 交差点を原点にローカル平面座標変換
2. 連続する2点を線分とみなす
3. 原点から線分までの最短距離を計算（ベクトル射影）

ヒット条件:

- `MIN_HITS = 1`

**点ヒット + 線分ヒット** の合計が1以上で通過扱いになります。

## 6. 曜日フィルタ

G列（GPS時刻）の `YYYYMMDD` から曜日を算出します。

- `TARGET_WEEKDAYS = {1〜7}`

指定曜日以外は判定対象外です。

## 7. 出力ファイル名の構造

出力形式:

- `2nd_{交差点名}_{曜日}_ID{運行ID}_{運行日}_tXXX_EYY_FZZ.csv`

例:

- `2nd_01nomura_MON_ID123456789012_20250224_t001_E01_F01.csv`

内容は元CSVの行をそのまま保存します。

## 8. 複数交差点への最適化

現在の実装は効率化されています。

- 以前: 交差点ごとに全ファイルを読み込み
- 現在: 1ファイルを読み込み → すべての交差点で判定

これにより、ファイルI/Oが大幅に削減されています。

## 9. 進捗表示の仕組み

以下をリアルタイム表示します。

- 全体進捗％
- 経過時間
- 推定残り時間（ETA）
- 交差点別ヒット件数

## 10. できること

- 交差点近傍通過トリップの抽出
- 複数交差点の同時処理
- 曜日別抽出
- 20m以内通過の高精度判定

## 11. できないこと（重要）

- 右折／左折判定
- 信号遅れの計測
- 通過方向の判定
- 車線単位の判定
- GPS補正

※「抽出されない＝通過していない」とは限りません。

## 12. 設計思想（このスクリプトの本質）

このスクリプトは、**「交差点の近傍を物理的に通ったかどうか」**だけを判定するものです。

方向解析や遅れ時間解析は後段（31・32・33系）で行います。

## 13. 重要パラメータ

| 変数 | 意味 | 推奨 |
|---|---|---|
| `THRESH_M` | 判定距離 | 20m |
| `MIN_HITS` | 必要ヒット数 | 1 |
| `RECURSIVE` | サブフォルダ探索 | True |

## 14. よくある誤解

- ❌ 20m以内に「点」がなければ不通過  
  → 実際は線分補正あり
- ❌ 交差点CSVの全行が使われる  
  → 最初の1行だけ使用
- ❌ 1回ヒットしたら1ファイル1件  
  → 区間ごとに複数保存される

## 15. このスクリプトの位置づけ

```text
11_crossroad_sampler
      ↓
21_point_trip_extractor
      ↓
31_crossroad_trip_performance
      ↓
32_crossroad_report
```

## まとめ（初見の人向け）

このスクリプトは、

1. GPS軌跡を区間に分割し
2. 交差点中心から20m以内を通った区間を
3. 高精度距離計算で判定し
4. 新しいCSVとして保存する

**交差点ベースの第2スクリーニング抽出エンジン**です。
