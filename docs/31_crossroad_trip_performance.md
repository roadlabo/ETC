# 31_crossroad_trip_performance.py マニュアル

`31_crossroad_trip_performance.py` は、第2スクリーニング済み（様式1-2）CSV群と交差点定義CSVを入力し、**交差点を通過した“1回の通過”ごと**に性能指標を算出して `*_performance.csv` を出力します。

このスクリプトは、次の2つを分けて管理します。
- **通過したか（交通量として数えるか）**
- **所要時間が計算できたか（品質として判別する）**

---

## 1. 入力

### 1.1 第2スクリーニング済み（様式1-2）CSV
- 交差点近傍を通る可能性があるトリップの点列（緯度経度＋GPS時刻 等）
- 本スクリプトは **ヘッダ無しCSV** を前提として、列番号（0始まり）で読み取ります。

使用列（主要）：
- 運行日: `COL_DATE = 2`（YYYYMMDD）
- 運行ID: `COL_RUN_ID = 3`
- 自動車の種別: `COL_VEHICLE_TYPE = 4`
- 用途: `COL_VEHICLE_USE = 5`
- GPS時刻: `COL_GPS_TIME = 6`（YYYYMMDDhhmmss）
- トリップ番号: `COL_TRIP_NO = 8`
- 経度: `COL_LON = 14`
- 緯度: `COL_LAT = 15`

> 補足：トリップ番号列が無い場合は、CSV全体を1トリップとして扱います（`trip_groups = [("ALL", df)]`）。

### 1.2 交差点定義CSV（11で作成）
交差点中心と枝情報を読み取ります。
- 交差点ID
- 中心（経度・緯度）
- 枝番
- 枝の方向角（`dir_deg`）

---

## 2. 出力

### 2.1 出力ファイル
出力先は「プロジェクト指定の有無」で変わります。

- `--project` 指定なしの場合  
  `OUTPUT_BASE_DIR` 配下に出力  
  `.../<交差点名>_performance.csv`

- `--project` 指定ありの場合  
  プロジェクト配下の `31_交差点パフォーマンス` に出力  
  `.../<交差点名>_performance.csv`

文字コード：
- 最終出力 `*_performance.csv` は `cp932`

### 2.2 出力行の単位（重要）
**「1トリップ=1行」ではありません。**
- 交差点付近でのヒット点が複数の塊に分かれる場合、**1トリップから複数回の通過イベント**を作り、イベントごとに **必ず1行** 出力します。
- 出力 `トリップID` は `元のtrip_no-P01` のように通過番号が付きます（例：`12-P02`）。

### 2.3 出力列（概要）
出力列は多いので、ここでは意味が伝わる単位で説明します。

**基本情報**
- 交差点ファイル名、交差点ID、抽出CSVファイル名
- 運行日、曜日、運行ID、トリップID、自動車の種別、用途

**枝判定（流入・流出）**
- 流入枝番 / 流出枝番
- 流入角度deg / 流出角度deg
- 角度差（枝のdir_degとのズレ）
- 角度算出方式（例：`IN:20-50m/OUT:20-70m`）

**所要時間・遅れ**
- 計測距離(m)（定義上は前後距離の合計）
- 所要時間(s)
- 閑散時所要時間(s)（方向別T0）
- 遅れ時間(s) = 所要時間 - T0
- 所要時間算出可否（1/0）
- 所要時間算出不可理由（OK / TIME_MISSING / OUT_OF_RANGE / NO_SEGMENT）

**診断用（中心ずれ・補間・生点）**
- 交差点中心（指定値）と、算出中心（最近接点）の比較
- 計測開始/終了位置、補間した開始/終了座標・時刻
- 中心付近の前後4点＋中央（可視化・検証用）

---

## 3. 主要な処理の流れ（スクリプトがやっていること）

### 3.1 対象交差点セットの組み立て
交差点ごとに「第2スクリーニングフォルダ」と「交差点定義CSV」を1セットとして処理します。

- `--project` 指定ありの場合、次の固定フォルダ構成から自動で探索します。
  - 交差点CSV：`<project>/11_交差点(Point)データ/*.csv`
  - 第2スクリーニング：`<project>/20_第２スクリーニング/<交差点名>/*.csv`
  - 出力：`<project>/31_交差点パフォーマンス/`
- `--targets` を指定すると、その交差点名（stem）だけに絞ります。

### 3.2 曜日フィルタ
運行日（YYYYMMDD）から曜日（MON..SUN）を作り、`--weekdays` で対象曜日だけ残します。
- `ALL`（または未指定）の場合は全曜日対象

### 3.3 トリップの点列を作る
1トリップ分の行をまとめ、次を作ります。
- `points`: (lat, lon) の配列
- `gps_times`: GPS時刻文字列の配列

点が2点未満の場合は解析できないためスキップします。

### 3.4 「交差点を通過したか」をイベントとして抽出する
このスクリプトは、交差点通過を次の2種類でヒット判定します。
- 点が中心から一定半径以内（`--radius-m`）
- 連続2点の線分が中心に一定距離以内（`--radius-m`）

ヒットした index を集め、近いもの（ギャップ<=2点）をまとめて
`(start_idx, end_idx)` の **通過イベント** の配列を作ります。

イベントが1つも無いトリップは「不通過」として除外します。

### 3.5 通過イベントごとに「算出中心」を決める（重要）
各通過イベントについて、イベント区間の前後も少し広げて探索し、
交差点中心に最も近い **線分（i, i+1）** と、その線分上の最近接点（t=0..1）を求めます。

ここで得る「線分上の最近接点」を、このイベントの **算出中心** として使います。
- 交差点定義上の中心点そのものではなく、トリップ軌跡に沿って安定する中心に置き換えるためです。

### 3.6 枝判定（流入/流出）を3段階で行う
枝判定は、算出中心の「道なり距離位置」を基準に、前後の2点を補間で作って方位角を出します。

**3段階判定（成功した段階を採用）**
- 20-50m：閾値30°
- 20-70m：閾値35°
- 20-100m：閾値40°

**流入（IN）**
- `center - far` → `center - near` の進行方位を求める
- 進行方位は車両の向きなので、枝の定義（中心→外側）に合わせるため **180°反転**して比較

**流出（OUT）**
- `center + near` → `center + far` の進行方位を求める
- OUTは反転しない（中心→外側と向きが一致）

その角度と、交差点定義CSVにある全枝の `dir_deg` を比較し、
角度差が最小の枝を候補にして、閾値以内なら確定します。

角度算出方式は `IN:20-50m/OUT:20-70m` のように出力されます。

### 3.7 所要時間の算出（線形補間）
所要時間は、**算出中心** を基準に「前100m〜後20m」の区間で測ります。
- 前距離：`MEASURE_PRE_M = 100.0`
- 後距離：`MEASURE_POST_M = 20.0`
- 計測距離：`MEASURE_PRE_M + MEASURE_POST_M`（定義上固定）

処理手順：
1. 点列から累積距離 `cumdist`（道なり距離）を作る
2. 算出中心が線分上の何m地点か（`center_pos`）を出す
3. `start_pos = center_pos - 100m`、`end_pos = center_pos + 20m` を作る
4. `start_pos` と `end_pos` の座標・時刻を **線形補間**で求める
5. `所要時間(s) = end_time - start_time`

算出不可の代表例：
- GPS時刻の欠損（TIME_MISSING）
- 計測区間がトリップの範囲外（OUT_OF_RANGE）
- 最近接線分が取れない（NO_SEGMENT）

> 注意：所要時間が算出できなくても、通過イベントとしては **行を出力**します（交通量の母数を落とさないため）。

### 3.8 閑散時所要時間（T0）と遅れ時間
一度、全通過イベントの行を temp CSV に書き出してから、
方向別（流入枝番×流出枝番）に「所要時間(s)」の分布を集計します。

- 方向別に所要時間を昇順ソート
- 下位5%（最低1件）の平均を **T0** とする
- 遅れ時間 = 所要時間 - T0

その後、temp CSV を読み直して T0 と遅れを埋め、最終CSVへ書き出します。

---

## 4. 使い方（CLI）

### 4.1 プロジェクトフォルダ指定で実行（推奨）
```bash
python src/31_crossroad_trip_performance.py --project "D:\ETC\PROJECT"
```

交差点を絞る（stem名）：
```bash
python src/31_crossroad_trip_performance.py --project "D:\ETC\PROJECT" --targets 01_xxx 02_yyy
```

曜日を絞る：
```bash
python src/31_crossroad_trip_performance.py --project "D:\ETC\PROJECT" --weekdays MON TUE WED
```

HIT半径（通過判定の半径）：
```bash
python src/31_crossroad_trip_performance.py --project "D:\ETC\PROJECT" --radius-m 30
```

temp CSV を残す（デバッグ用）：
```bash
python src/31_crossroad_trip_performance.py --project "D:\ETC\PROJECT" --keep-temp
```

進捗ログ出力間隔を変える：
```bash
python src/31_crossroad_trip_performance.py --project "D:\ETC\PROJECT" --progress-step 1000
```

### 4.2 `OUTPUT_BASE_DIR` / `CONFIG` を手で書いて実行
スクリプト先頭の `OUTPUT_BASE_DIR` と `CONFIG` を編集して実行します。
```bash
python src/31_crossroad_trip_performance.py
```

---

## 5. よくある見方（出力の読み取り）

### 5.1 交通量としての「通過件数」
- `*_performance.csv` の **行数** が、通過イベント数（交通量のベース）です。
- 所要時間NGでも行は出ます。品質判定は次項で判別します。

### 5.2 所要時間が使える行だけを集計対象にする
集計（平均遅れ等）に使うのは次を満たす行です。
- `所要時間算出可否 = 1`
- `所要時間算出不可理由 = OK`

---

## 6. 注意事項
- `--radius-m` を大きくするとイベントが増えやすくなり、通過判定が緩くなります。
- 点列が短い（計測区間が取れない）トリップは `OUT_OF_RANGE` になりやすいです。
- 枝判定は「最も近い枝 + 閾値」の方式です。枝定義CSVの `dir_deg` の品質が結果に直結します。

---

<details>
<summary>HEADER 全列（実装定義順）</summary>

1. `交差点ファイル名`
2. `交差点ID`
3. `抽出CSVファイル名`
4. `運行日`
5. `曜日`
6. `運行ID`
7. `トリップID`
8. `自動車の種別`
9. `用途`
10. `流入枝番`
11. `流出枝番`
12. `流入角度deg`
13. `流出角度deg`
14. `流入角度差(deg)`
15. `流出角度差(deg)`
16. `角度算出方式`
17. `計測距離(m)`
18. `所要時間(s)`
19. `閑散時所要時間(s)`
20. `遅れ時間(s)`
21. `所要時間算出可否`
22. `所要時間算出不可理由`
23. `計測区間_前(m)`
24. `計測区間_後(m)`
25. `中心最近接距離(m)`
26. `中心最近接位置(m)`
27. `計測開始位置(m)`
28. `計測終了位置(m)`
29. `計測開始_経度(補間)`
30. `計測開始_緯度(補間)`
31. `計測開始_GPS時刻(補間)`
32. `計測終了_経度(補間)`
33. `計測終了_緯度(補間)`
34. `計測終了_GPS時刻(補間)`
35. `交差点中心_経度`
36. `交差点中心_緯度`
37. `算出中心_経度`
38. `算出中心_緯度`
39. `算出中心_GPS時刻`
40. `point-4経度`
41. `point-4緯度`
42. `point-4GPS時刻`
43. `point-3経度`
44. `point-3緯度`
45. `point-3GPS時刻`
46. `point-2経度`
47. `point-2緯度`
48. `point-2GPS時刻`
49. `point-1経度`
50. `point-1緯度`
51. `point-1GPS時刻`
52. `【中央】経度`
53. `【中央】緯度`
54. `【中央】GPS時刻`
55. `point+1経度`
56. `point+1緯度`
57. `point+1GPS時刻`
58. `point+2経度`
59. `point+2緯度`
60. `point+2GPS時刻`
61. `point+3経度`
62. `point+3緯度`
63. `point+3GPS時刻`
64. `point+4経度`
65. `point+4緯度`
66. `point+4GPS時刻`

</details>
