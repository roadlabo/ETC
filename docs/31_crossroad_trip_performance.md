# 31_crossroad_trip_performance
## 目的（何をする）
第2スクリーニング済みの様式1-2 CSV と交差点定義を入力し、交差点通過の所要時間と遅れ時間（流入方向・流出方向別）を算出して、交差点ごとに性能 CSV を出力する。
交差点中心は「指定中心点そのもの」ではなく、トリップ軌跡のうち指定中心点に最も近い**線分上最近接点（算出中心）**を基準として扱う。
交差点の「通過のしづらさ（減速・信号待ち・右左折の譲り合い等）」が反映されるように、交差点周辺の一定区間の所要時間を算出し、方向別の閑散時所要時間 T0 を基準として **遅れ時間(s)=所要時間(s)-T0(s)** を出力する。
## 位置づけ（分析フロー上のどこ）
- **性能評価**フェーズ（交差点）。
- PDF 用語の「交差点性能算出」を担当し、32 のビューアで確認する出力を生成。
- 旧 70 系のロジックを 31 系として整理した正式版。
## 入力
- CONFIG 配列で指定するセットごとに処理。
  - `trip_folder`: 第2スクリーニング済み様式1-2 CSV を含むフォルダ。
  - `crossroad_file`: 交差点定義 CSV（11_crossroad_sampler 出力）。
- 列前提（入力 CSV, 0 始まり）: 運行日=2, 運行ID=3, 種別=4, 用途=5, GPS時刻=6, TRIP_NO=8, 経度=14, 緯度=15。
- `TARGET_WEEKDAYS` で曜日フィルタを適用可能（例: ["TUE","WED","THU"]）。
## 出力
- `{PROJECT_ID}/31_交差点パフォーマンス/{crossroad_name}_performance.csv`（cp932）。
- 主要列（例）:
  - 流入枝番 / 流出枝番
  - 計測距離(m)
  - 所要時間(s)
  - 閑散時所要時間(s)
  - 遅れ時間(s)
  - 所要時間算出可否 / 所要時間算出不可理由
- 診断列（補間区間・最近接情報）:
  - 計測区間_前(m) / 計測区間_後(m)
  - 中心最近接距離(m)
  - 中心最近接位置(m)
  - 計測開始/終了位置(m)
  - 計測開始/終了の経度・緯度・GPS時刻（補間）
  - 交差点中心（指定）と算出中心（線分上最近接点）の座標・時刻

※作業フォルダ構成は `docs/05_work_folder_structure.md` を正とする。  
本スクリプトの出力先は `{PROJECT_ID}/31_交差点パフォーマンス/` で運用する。

### 交通量と所要時間算出品質を分離する（重要）
本スクリプトは「交差点を通ったか（交通量）」と「所要時間を算出できるか（品質）」を分離して出力する。
- 交通量（通過台数）: **通過判定OKの行を必ず出力**し、出力行数の合計で集計する（通過カウント列は廃止）。
- 遅れ集計: `所要時間算出可否=1` の行のみを対象とする（`所要時間(s)` が空欄の行は遅れ集計から除外）。

追加列の意味：
- `所要時間算出可否`：1=算出可、0=算出不可
- `所要時間算出不可理由`：
  - `OK`：算出可
  - `OUT_OF_RANGE`：計測区間（前後距離）がトリップ範囲外
  - `TIME_MISSING`：GPS時刻欠損等で補間不可
  - `NO_SEGMENT`：中心最近接線分が取得できない（例外）
## 実行方法
- スクリプト冒頭で `OUTPUT_BASE_DIR`, `CONFIG`, `TARGET_WEEKDAYS` を設定（`OUTPUT_BASE_DIR` は `{PROJECT_ID}/31_交差点パフォーマンス/` に合わせる）。
- コマンド例: `python 31_crossroad_trip_performance.py`
- セットごとに進捗を標準出力へ表示。入力フォルダに CSV が無ければスキップ。
## 判定ロジック（重要なものだけ）

## 交差点影響区間の所要時間・遅れ時間の定義（重要）
### 計測区間（デフォルト）
交差点中心への最近接点を基準として、走行方向に
- 前：`MEASURE_PRE_M`（例：100m）
- 後：`MEASURE_POST_M`（例：20m）
の区間を「影響区間」とする。

### 所要時間の求め方（線形補間）
ETC2.0 等で点が粗い場合でも評価がブレないように、道なり累積距離を用いて
- 開始位置（中心基準 -100m）
- 終了位置（中心基準 +20m）
の通過時刻を、前後点の間で線形補間して求める。

### 遅れ時間の算出
距離は固定（`MEASURE_PRE_M + MEASURE_POST_M`）とし、所要時間そのものを基本量として扱う。
- 計測距離(m) = `MEASURE_PRE_M + MEASURE_POST_M`
- 閑散時所要時間 T0(s) = 方向別（流入枝番×流出枝番）の所要時間 下位5%平均
- 遅れ時間(s) = 所要時間(s) - T0(s)

※右左折で実走行距離が僅かに伸びても距離は固定のため、「右左折のペナルティ（減速・待ち）」が遅れ時間として出やすい。

## 判定ロジック（重要なものだけ）
- TRIP_NO/FLAG に基づきトリップ単位で処理し、交差点中心に最も近い**線分（2点間）**を求める。
- その線分上の最近接点を「算出中心」とし、前後距離（例：-100m/+20m）の境界通過時刻を**道なり距離で線形補間**して所要時間を得る。
- 流入/流出枝番は、中心に最も近い線分の
  - 前点（上流側）を流入方向参照
  - 後点（下流側）を流出方向参照
 として、中心→参照点の方位角から最寄り枝番を選ぶ。
- 距離・方位閾値を超過する場合は「未マッチ」となるため、解釈は慎重に行う。

## 中心点ずれの検証（重要）
出力には、比較のために以下を出す：
- `交差点中心_経度/緯度`：交差点定義CSVで指定された中心点
- `算出中心_経度/緯度/算出中心_GPS時刻`：トリップ軌跡のうち、指定中心点に最も近い線分上最近接点（中心点シフトの可視化用）

## 所要時間算出不可条件（交通量からは除外しない）
次の場合でも「通過レコード」は出力する（交通量に含める）が、所要時間は算出不可として空欄になる。
- GPS時刻が欠損して補間できない → `所要時間算出可否=0`, `所要時間算出不可理由=TIME_MISSING`
- 計測区間（前後距離）がトリップの範囲外に出る → `所要時間算出可否=0`, `所要時間算出不可理由=OUT_OF_RANGE`
※所要時間算出の OK/NG 件数は標準出力に表示する。
## できること / できないこと（行政向けの注意）
- できること: 交差点ごとの流入/流出方向別性能集計、曜日別のフィルタ、中心周辺の生データを付与した CSV 出力。
- できないこと: 信号現示や交差点形状の自動取得、右左折の確定判定、長時間滞留の原因特定。距離・方位閾値を超える場合は「未マッチ」となるため、解釈は慎重に行う。
## よくあるミス
- CONFIG の `trip_folder` と `crossroad_file` の組み合わせを誤り、座標系が一致せず全件ミスマッチ。
- 入力 CSV の文字コード/改行が異なり、読み込みで警告が出る。
- `TARGET_WEEKDAYS` を設定したまま全曜日を想定して結果件数が減少する。
## 関連スクリプト
- 前段: [docs/21_point_trip_extractor.md](./21_point_trip_extractor.md)（第2スクリーニング）。
- 後段: [docs/32_crossroad_report.md](./32_crossroad_report.md)（性能 CSV のレポート出力）。
- フロー全体: [docs/01_pipeline.md](./01_pipeline.md)

## 変更履歴
- 2026-01-06: 「前後点数（±5点）」方式を廃止し、「前100m〜後10mの境界補間」方式へ変更。
- 2026-01-06: 通過レコードは必ず出力し交通量に含める。所要時間算出は可否と理由を列で分離（所要時間欠損でも除外しない）。
- 2026-01-07: 計測区間を 前200m〜後20m に変更。中心点は指定中心ではなく「算出中心（線分上最近接点）」を基準に扱い、指定中心と算出中心の差分確認用の列を追加。最近接線分（前後点/t）の出力は廃止。
- 2026-01-08: 速度指標を廃止し、所要時間・閑散時所要時間・遅れ時間の出力に統一。計測区間は前100m〜後20m（距離120m固定）に変更。
