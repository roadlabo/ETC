# 31_crossroad_trip_performance 完成版マニュアル

## 1. 目的
`31_crossroad_trip_performance.py` は、第2スクリーニング済みの様式1-2 CSV と交差点定義 CSV を入力し、交差点通過トリップごとの性能指標を `*_performance.csv` として出力します。

本処理の主目的は次の2点です。
- 交通量（= 交差点を通過したトリップ件数）を、通過判定ベースで欠落なく残す。
- 所要時間算出品質（算出可否・不可理由）を分離して、遅れ時間評価の対象を明確化する。

---

## 2. 位置づけ
- パイプライン上の「交差点性能算出」工程です。
- 後段の `32_crossroad_report.py` / `33_branch_check.py` が直接参照する `*_performance.csv` を作成します。

---

## 3. 入力仕様

### 3.1 設定値
スクリプト先頭の以下を編集します。
- `OUTPUT_BASE_DIR`
- `CONFIG`（`trip_folder`, `crossroad_file` の組）
- `TARGET_WEEKDAYS`（`MON`〜`SUN`。空配列で全曜日対象）

### 3.2 様式1-2 CSV（ヘッダ無し）
列は 0 始まり固定です。
- `COL_DATE = 2`（運行日）
- `COL_RUN_ID = 3`（運行ID）
- `COL_VEHICLE_TYPE = 4`（自動車の種別）
- `COL_VEHICLE_USE = 5`（用途）
- `COL_GPS_TIME = 6`（GPS時刻）
- `COL_TRIP_NO = 8`（トリップ番号）
- `COL_LON = 14`（経度）
- `COL_LAT = 15`（緯度）

### 3.3 交差点定義 CSV（11 出力）
最低限、次を読み取れる必要があります（位置参照）。
- 交差点ID
- 中心経度
- 中心緯度
- 枝番
- 枝方向角（`dir_deg` 相当）

---

## 4. 出力仕様

### 4.1 出力先
- `{OUTPUT_BASE_DIR}/{crossroad_name}_performance.csv`
- 文字コード: `cp932`

### 4.2 出力列（CSV正式名称）
以下の順で出力されます。

1. `交差点ファイル名`
2. `交差点ID`
3. `抽出CSVファイル名`
4. `運行日`
5. `曜日`
6. `運行ID`
7. `トリップID`
8. `自動車の種別`
9. `用途`
10. `流入枝番`
11. `流出枝番`
12. `流入角度deg`
13. `流出角度deg`
14. `流入角度差(deg)`
15. `流出角度差(deg)`
16. `角度算出方式`
17. `計測距離(m)`
18. `所要時間(s)`
19. `閑散時所要時間(s)`
20. `遅れ時間(s)`
21. `所要時間算出可否`
22. `所要時間算出不可理由`
23. `計測区間_前(m)`
24. `計測区間_後(m)`
25. `中心最近接距離(m)`
26. `中心最近接位置(m)`
27. `計測開始位置(m)`
28. `計測終了位置(m)`
29. `計測開始_経度(補間)`
30. `計測開始_緯度(補間)`
31. `計測開始_GPS時刻(補間)`
32. `計測終了_経度(補間)`
33. `計測終了_緯度(補間)`
34. `計測終了_GPS時刻(補間)`
35. `交差点中心_経度`
36. `交差点中心_緯度`
37. `算出中心_経度`
38. `算出中心_緯度`
39. `算出中心_GPS時刻`
40. `point-4経度`
41. `point-4緯度`
42. `point-4GPS時刻`
43. `point-3経度`
44. `point-3緯度`
45. `point-3GPS時刻`
46. `point-2経度`
47. `point-2緯度`
48. `point-2GPS時刻`
49. `point-1経度`
50. `point-1緯度`
51. `point-1GPS時刻`
52. `【中央】経度`
53. `【中央】緯度`
54. `【中央】GPS時刻`
55. `point+1経度`
56. `point+1緯度`
57. `point+1GPS時刻`
58. `point+2経度`
59. `point+2緯度`
60. `point+2GPS時刻`
61. `point+3経度`
62. `point+3緯度`
63. `point+3GPS時刻`
64. `point+4経度`
65. `point+4緯度`
66. `point+4GPS時刻`

---

## 5. 通過判定と品質判定の分離

### 5.1 通過判定（交通量）
トリップが交差点中心近傍を通過した場合、そのトリップは **必ず1行出力** されます。
- この出力行数合計が通過交通量のベースです。

### 5.2 所要時間算出可否（品質）
`所要時間算出可否` と `所要時間算出不可理由` で品質を管理します。
- `所要時間算出可否`: `1`（算出可）/ `0`（算出不可）
- `所要時間算出不可理由`:
  - `OK`
  - `TIME_MISSING`
  - `OUT_OF_RANGE`
  - `NO_SEGMENT`

`遅れ時間(s)` の集計対象は、`所要時間(s)` が算出された行のみです。

---

## 6. 時間算出（所要時間・遅れ時間）

> ここは枝角度算出とは独立です。

### 6.1 基準中心
- 交差点定義上の指定中心ではなく、トリップ軌跡に対する「指定中心への最近接線分上最近接点（算出中心）」を基準にします。

### 6.2 計測区間
- `MEASURE_PRE_M = 100.0`
- `MEASURE_POST_M = 20.0`

算出中心の道なり距離位置を基準に、
- 開始位置: `-100m`
- 終了位置: `+20m`
を取り、境界時刻を線形補間します。

### 6.3 所要時間
- `所要時間(s) = 計測終了時刻 - 計測開始時刻`
- `計測距離(m) = 120m`（`MEASURE_PRE_M + MEASURE_POST_M` 固定）

### 6.4 閑散時所要時間・遅れ
方向別キー（`流入枝番` × `流出枝番`）ごとに
- `閑散時所要時間(s)` = `所要時間(s)` の下位 5% 平均（最低1件）
- `遅れ時間(s)` = `所要時間(s)` - `閑散時所要時間(s)`

---

## 7. 角度算出（流入/流出枝判定）

> ここは所要時間算出区間とは独立です。

### 7.1 角度算出用サンプル距離

都市部（ビル街）などで GNSS が横方向に 10〜20m 程度シフトするケースを考慮し、
**距離と閾値を段階的に変更する 3 段階判定方式**を採用します。

基本方針は次の通りです。
- **近距離（5–30m）は厳しく**：誤判定（隣枝への吸い込み）を抑える。
- **中距離（5–40m）は救済**：ジグザグや単発ノイズがある場合に方向を安定化して拾う。
- **長距離（5–50m）は最終救済**：それでも不安定なら最後に拾えるものだけ拾う。
- **3段階すべて不成立なら不明枝**：誤判定より「不明」を優先する。

#### 7.1.1 サンプル点（補間点）の取り方
交差点中心は「指定中心点」そのものではなく、トリップ軌跡に対する
**指定中心への最近接線分上の最近接点（算出中心）**を基準にします（第6章参照）。
以後、算出中心の道なり距離位置（中心最近接位置）を `center_pos` として扱います。

角度算出では、道なり距離 `center_pos` からのオフセット距離で、2点を補間します。

- 流入（IN）:
  - 近点: `center_pos - 5m`
  - 遠点: `center_pos - {30m, 40m, 50m}`（段階的）
  - まず `center-far -> center-near` の進行方位を求め、
    **180°反転**して「中心→枝」方向（center->branch）に整合します。

- 流出（OUT）:
  - 近点: `center_pos + 5m`
  - 遠点: `center_pos + {30m, 40m, 50m}`（段階的）
  - `center+near -> center+far` の進行方位を求め、そのまま「中心→枝」方向として使います。

補間点が範囲外で取得できない場合は、その段階はスキップし、次の段階に進みます。

### 7.2 枝番決定

#### 7.2.1 基本（全枝から最小角度差を選ぶ）
各段階で求めた角度（deg）に対して、交差点定義 CSV の全枝（`dir_deg` 相当）を走査し、
**角度差が最小の枝**を候補とします。
ここは「枝番号 1→2→3… の早い者勝ち」ではなく、
**毎回、全枝を比較して最小差分を採用**します。

#### 7.2.2 3段階判定（距離 × 閾値テーブル）
段階的に `far` と許容角度差（閾値）を変更して判定します。

- 第1段階: `5–30m` で角度差 `<= 30°` なら確定
- 第2段階: `5–40m` で角度差 `<= 40°` なら確定
- 第3段階: `5–50m` で角度差 `<= 45°` なら確定

いずれの段階でも確定できない場合は、該当側（流入/流出）の枝番は **空欄（不明）** とします。

この方式により、
- 近距離は厳しく（誤判定抑制）
- 近距離がノイズで崩れた場合のみ遠距離で救済（方向安定化）
という意図を実装に落とし込みます。

#### 7.2.3 出力列への反映
- 判定結果：`流入枝番` / `流出枝番`
- 角度：`流入角度deg` / `流出角度deg`
- 差分：`流入角度差(deg)` / `流出角度差(deg)`

さらに `角度算出方式` 列には、どの段階で確定したかを残します。
例：
- `IN:tier(5-30<=30)`
- `IN:tier(5-40<=40)`
- `IN:tier(5-50<=45)`
- `IN:tier_nohit`
- `OUT:tier(5-30<=30)`
- `OUT:tier_nohit`

これにより、
「厳しい第1段階で確定できたトリップ」と「救済段階で確定したトリップ」を後から切り分けて確認できます。

#### 7.2.4 例外（補間点が取れない場合の保守的 fallback）
算出中心が取れない等で補間点による角度算出ができない場合は、
生点インデックスから近傍2点で方位を推定する fallback を行います。
ただし誤判定を避けるため、fallback の採用は **角度差 `<= 30°` の場合に限定**します。
（それ以外は枝を空欄（不明）にします。）

---

## 8. 実行方法
```bash
python src/31_crossroad_trip_performance.py
```

デバッグ用（中間 temp CSV 保持）:
```bash
python src/31_crossroad_trip_performance.py --keep-temp
```

---

## 9. 後方互換の挙動
- 31/16 系ロジック準拠のため、`32_crossroad_report.py` / `33_branch_check.py` が参照する主要列（例: `流入枝番`, `流出枝番`, `所要時間(s)`, `遅れ時間(s)`）は維持されています。
- 交通量は「通過行数」で扱う設計に統一されており、通過判定済みレコードは所要時間NGでも出力されます（品質列で識別）。
- 追加診断列（補間座標・中心比較・生点列）は後段可視化互換のため維持されます。

---

## 10. 注意事項
- `TARGET_WEEKDAYS` を設定すると件数が減少します（仕様通り）。
- `trip_folder` と `crossroad_file` の組が異なる地域/座標系だと枝判定・通過判定が崩れます。
- `所要時間算出可否=0` の行は遅れ評価対象に使わないでください。
