# 30_build_performance
## 目的（何をする）
第2スクリーニング済みのトリップ CSV から、ルート沿いの速度・通過性能を集計する。キロポスト（KP）を自動計算し、時間帯別平均速度と通過件数を出力する。
## 位置づけ（分析フロー上のどこ）
- **性能評価**フェーズ。
- PDF 用語での「第2スクリーニング後の性能集計」に該当し、ルート単位の速度プロファイルを作る。
## 入力
- `INPUT_DIR`: `20_route_trip_extractor.py` 等が出力した様式1-2 互換 CSV 群。サブフォルダ探索は `RECURSIVE` で制御。
- `ROUTE_PATH`: サンプルルート CSV（経度=14, 緯度=15 を使用）。
- 列前提: 時刻=6, 経度=14, 緯度=15, 速度=18（km/h）。
## 出力
- `OUTPUT_PATH`: Shift_JIS/CRLF の CSV。ヘッダは `KP[km]`、時速24列、`KP[km]` 再掲、件数24列。
- ファイル名例: `paformance001.csv`（任意指定）。

※作業フォルダ構成は `docs/05_work_folder_structure.md` を正とする。  
本スクリプトの成果物は `{PROJECT_ID}/30_ルートパフォーマンス/`（該当番号フォルダ）に出力して運用する。
## 実行方法
- スクリプト冒頭で `INPUT_DIR`, `ROUTE_PATH`, `OUTPUT_PATH`, `RADIUS_M`（近接閾値[m]）を設定。
- コマンド例: `python 30_build_performance.py`
- 進捗と統計（行数・距離判定件数など）が標準出力に表示される。
## 判定ロジック（重要なものだけ）
- ルート座標を用いて KP[km] を計算（経度=14/緯度=15 の差分距離を積算）。
- 各観測点を最近傍ルート点との距離で判定し、`RADIUS_M` 以内のみ集計。
- 時刻を 0–23 時間に変換し、速度の平均と件数を時間別・KP 列に格納。lon/lat 入替が多い場合は自動修正の防御ロジックあり。
## できること / できないこと（行政向けの注意）
- できること: ルート沿いの時間帯別速度指標作成、KP 単位の通過件数集計、距離閾値の調整による感度確認。
- できないこと: 測位誤差の補正、速度外れ値の自動除去（閾値は固定）、信号・渋滞要因の識別。出力は平均値であり、交通規制判断の根拠単独にはならない。
## よくあるミス
- `ROUTE_PATH` を第1スクリーニング前の座標にして距離判定が失敗。
- 速度列を km/h 以外で持つファイルを混在させ、平均が崩れる。
- 文字コードを UTF-8 のまま開いて文字化け（出力は cp932）。
## 関連スクリプト
- 前段: [docs/20_route_trip_extractor.md](./20_route_trip_extractor.md)。
- 後段: レポート化・可視化は [docs/05_route_mapper_simple.md](./05_route_mapper_simple.md) などで補助。
- 兄弟: 交差点性能は [docs/31_crossroad_trip_performance.md](./31_crossroad_trip_performance.md)。
- フロー全体: [docs/01_pipeline.md](./01_pipeline.md)
