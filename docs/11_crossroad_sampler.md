# 11_crossroad_sampler（交差点定義ファイル作成ツール）

## このツールの目的

`11_UI_crossroad_sampler.py`（PyQt6）と `11_crossroad_sampler.html`（Leaflet + JavaScript）は、
**交差点を「中心座標 + 枝方向（dir_deg）」として定義するための作成ツール**です。

生成物は次の2つです。

- `交差点名.csv`：交差点定義（中心・枝番号・方位角）
- `交差点名.jpg`：定義した交差点の地図キャプチャ

保存先はプロジェクト配下の `11_交差点(Point)データ` フォルダです。

---

## 全体アーキテクチャ（2層）

このツールは以下の役割分担で動きます。

1. **PyQt6層 (`11_UI_crossroad_sampler.py`)**
   - プロジェクトフォルダ選択
   - 一覧テーブル更新（CSV/JPG有無）
   - 保存・編集・リネーム・削除の管理
   - WebChannel経由でHTML側へ保存指示

2. **HTML/JS層 (`11_crossroad_sampler.html`)**
   - 地図操作（中心点・枝追加/削除）
   - 方位角計算（bearing）
   - CSV文字列生成（`buildCsvText()`）
   - html2canvasでJPG化

---

## ① HTML側の動き（地図操作と定義生成）

### 1. 地図の初期化

Leaflet地図を初期中心 `35.069095, 134.004512`、ズーム16で開始します。
背景タイルは OpenStreetMap を利用します。

### 2. 最初の左クリックで中心を確定

地図の最初の左クリックで中心が確定します。

- `centerLatLng` に中心座標を保持
- 中心は青色リング（塗り透明）で描画

中心が未設定のままでは保存できません。

### 3. 2回目以降の左クリックで枝を追加

中心確定後の左クリックでは、クリック位置そのものを枝終点には使わず、以下の手順で登録します。

1. `bearing(center → click)` を計算
2. その方位に対し、中心から **120m** 先の仮想点を `destinationPoint()` で算出
3. その仮想点を枝として `branchPoints` に追加

描画時は見やすさのための調整が入ります。

- 線の始点：中心リング外側（半径22px）
- 線の終点：方向ベクトルを **2倍延長**
- 枝番号：巨大ラベル（1,2,3...）を終点外側に配置

### 4. 右クリックで最後の枝を1本取り消し

`contextmenu` イベントで、最後に追加した枝をLIFO順で削除します。
（`branchPoints` / `branchMarkers` / `branchLines` を同時に `pop`）

### 5. 方位角計算（`bearing`）

`bearing()` は球面計算で方位角を求めます。

- 範囲：`0 <= deg < 360`
- 基準：北=0°、時計回り

この値がCSVの `dir_deg` になります。

### 6. CSV生成（`buildCsvText()`）

保存時に次形式でテキスト化されます。

```csv
crossroad_id,center_lon,center_lat,branch_no,branch_name,dir_deg
001,134.xxxxxxxx,35.xxxxxxxx,1,,123.45
001,134.xxxxxxxx,35.xxxxxxxx,2,,278.90
```

仕様上のポイント：

- 中心専用行は作らない（枝行のみ）
- 各行に同じ `center_lon/center_lat` を持つ
- `branch_name` は空欄
- `dir_deg` は小数2桁

### 7. 保存用JPG生成

`beginSaveFromPy()` では、保存前に以下を行います。

- 全枝と番号ラベルが入るよう `fitBounds` で表示範囲を調整
- `html2canvas` で `#map` をキャプチャ
- JPEG DataURL化してQtへ送信

---

## ② PyQt6側の動き（ファイル管理）

### 1. プロジェクト選択

「選択」ボタンでプロジェクトフォルダを選ぶと、
`{PROJECT}/11_交差点(Point)データ` を自動作成します。

同時にHTMLを埋め込みモードで読み込み、既存CSV/JPGを走査して一覧表示します。

### 2. WebChannel連携

Qt側で `Bridge` を `bridge` 名で登録し、HTMLから `bridge.requestSave(JSON)` を呼べるようにします。

保存要求JSONには主に次が含まれます。

- `base_name`
- `overwrite`
- `csv_text`
- `jpg_data_url`

### 3. 保存処理（`Bridge.requestSave`）

Qt側で以下を順に実施します。

1. JSON解析
2. 交差点名・プロジェクト選択状態を検証
3. 重複チェック（非上書き時）
4. CSVを書き込み（改行をLFに正規化）
5. Base64 JPEGを書き込み
6. 保存成功シグナル発行

保存成功後はUI側で：

- 編集状態解除
- 入力名クリア
- HTMLを `clearAll()` で初期化
- 一覧テーブル再走査

### 4. 編集機能

一覧から選択して「編集」を押すと、既存CSV全文を読み取り `loadFromCsvText(csvText)` を実行します。

HTML側は：

- 1行目以降の最初のデータ行から中心復元
- 各行の `dir_deg` を読み、中心から120m先を再計算して枝復元

つまり、編集復元は「保存時の生座標」ではなく**角度定義（dir_deg）を正として再構成**します。

### 5. リネーム

同名チェック後、`旧名.csv/.jpg` を `新名.csv/.jpg` へ同時リネームします。

### 6. 削除

確認ダイアログ後、`csv` と `jpg` を同時削除します。

---

## 重要仕様（運用で詰まりやすい点）

- 中心未設定では保存不可
- 枝0本では保存不可
- 同名ファイルは保存不可（同名編集中の上書き保存のみ許可）
- 枝削除は「最後に追加した1本」単位
- 枝線・番号位置はズーム/移動後も `updateBranches()` で再配置

---

## 11の中身からの補足（実装依存の注意）

1. **crossroad_id は常に `001` 固定で出力**
   - 実際の識別はファイル名（交差点名）に依存します。

2. **方向定義はクリック地点そのものではなく120m先の再計算点**
   - そのため、ユーザー操作は「方向指定」に近く、枝長は正規化されています。

3. **画像は保存前に自動で見切れ対策**
   - 枝先ラベルまで含む境界で `fitBounds` 後にキャプチャするため、一覧管理用JPGとして使いやすい作りです。

---

## 21 / 31 / 50 へのつながり（その3点まとめ）

> ここは「11で作ったCSVが後段でどう使われるか」を、実装ベースで簡潔に整理した補足です。

### 1) 21_point_trip_extractor での使われ方

`21` は主に **中心座標（center_lon, center_lat）** を使って、
トリップが交差点近傍を通ったかを距離判定で抽出します。

- 交差点CSVは先頭データ行の中心座標を読み取り
- 点/線分と中心の距離でヒット判定

この実装では `dir_deg` による枝番号判定は行っていません。

### 2) 31_crossroad_trip_performance での使われ方

`31` は `dir_deg` を使って流入枝/流出枝を推定します。

- 交差点CSVから `branch_no` と `dir_deg` を読み込み
- トリップ近傍点から進行方位を算出
- `angular_diff` が最小の枝を採用

したがって `11` 側で定義した角度が、`31` の枝別集計精度を直接左右します。

### 3) 50_Path_Analysis での使われ方

`50` は11のCSVから **2行目=枝1をA方向、3行目=枝2をB方向** として読み込みます。

- `dir_deg` を基準ベクトル化
- 交差点通過前後のベクトルと内積比較して A/B 判定
- A/B別に流入・流出ヒートマップを作成

`50` は実装コメント上、`dir_deg` を「outside→center基準」として扱うため、
11での枝1/枝2の定義順が可視化結果にそのまま反映されます。

---

## まとめ

`11_crossroad_sampler` は、交差点を「中心 + 方位ベクトル群」で定義し、
後続解析で使うための **基準座標系を確定するツール**です。

特に `dir_deg` と枝番号の整合性は、31/50の判定結果の土台になります。
