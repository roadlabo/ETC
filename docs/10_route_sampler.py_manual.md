# 10_route_sampler.py マニュアル  
（サンプルルート生成ツール・最新版）

---

# 🧭 概要

**route_sampler.py** は、地図上をクリックして経路（ルート）を作成し、  
ETC2.0 データ分析 ― 特に **route_mapper_simple.py** や **15_trip_extractor.py** で利用できる  
ルート定義 CSV を出力するツールです。

ブラウザ上の **OpenStreetMap** を利用し、  
- 左クリックで点追加  
- 右クリックで削除  
- 保存ボタンで CSV 出力  

という直感的な操作で利用できます。

---

# ⚙️ 動作環境

| 項目 | 内容 |
|------|------|
| 実行環境 | Python 3.10+ |
| 依存ライブラリ | Flask（`pip install flask`） |
| ブラウザ側 | Leaflet（CDN自動ロード） |
| 対応OS | Windows 10 / 11 |
| 出力ファイル | UTF-8 / BOMなし / ヘッダなし CSV |

---

# 🚀 起動方法

python route_sampler.py --outdir "D:\GitHub\ETC" --filename "sample.csv"

## ■ 主な引数

| 引数 | 説明 | 既定値 |
|------|------|--------|
| `--outdir` | 保存先フォルダ | スクリプトと同じ場所 |
| `--filename` | 出力ファイル名 | sample.csv |
| `--port` | Flask の起動ポート | 5009 |

起動後、ブラウザが自動で開きます：  
http://127.0.0.1:5009/

---

# 🗺️ 画面操作（Leaflet UI）

### ■ 基本操作
- **左クリック** → 点を追加
- **右クリック** → 直前の点を削除
- **「全消去」ボタン** → 全ての点をクリア
- **「保存」ボタン** → CSV 出力

### ■ 地図の初期設定
- 中心：津山市役所周辺  
  - 緯度：35.069095  
  - 経度：134.004512  
- ズーム：12  
- 背景：OpenStreetMap（TileServer）

---

# 💾 出力される CSV の仕様

出力 CSV は **route_mapper_simple.py と完全互換**です。

| 列番号 (0-based) | 内容 | 値・処理 |
|------|------------|---------|
| 4 (E列) | TYPE | `2`（固定ダミー） |
| 5 (F列) | USE | `1`（固定ダミー） |
| 6 (G列) | TIME | 先頭から10秒刻み（YYYYMMDDHHMMSS） |
| 12 (M列) | FLAG | `2`（全行固定） |
| 14 (O列) | 経度 lon | 小数10桁 |
| 15 (P列) | 緯度 lat | 小数10桁 |
| 18 (S列) | SPEED | `30.0`（固定） |
| その他 | 未使用 | `"0"` で埋める |

### ✔ 重要修正（2025-11-05）
- 出力順を **O列 = lon、P列 = lat** に統一  
- route_mapper_simple.py & trip_extractor.py と完全一致

---

# 📐 サンプリングアルゴリズム

クリックされた点列をそのまま保存せず、以下の処理を行います：

### ✔ 20m 間隔の等間隔化  
- ハヴァーサイン距離で判定  
- 長い区間は中間点を補完して均等化

### ✔ 30°以上の折れ点は必ず保持  
- 折れ点後は再び 20m ピッチでリセット

### ✔ 線分補間は「緯度経度の線形補間」  
短距離前提なので誤差は無視できるレベル。

---

# 🧩 出力ファイル名の命名ルール

- ファイル名に `.csv` が付いていない場合、自動で付加  
- 保存先は `--outdir`  
- 例：  
  - `sample.csv`  
  - `route_test.csv`

---

# 🧪 出力確認方法

1. 出力された CSV を **route_mapper_simple.py** に読み込む  
2. 地図上に設定したルートが描画される  
3. FLAG（M列=12）が全行「2」であることを確認  
4. 津山市内で正しく表示されることを確認

---

# 📖 ファイル構造（概略）

route_sampler.py
├─ Flask 起動部
│ ├─ / → 地図UI（Leaflet）
│ └─ /save → JSONを受け取りCSV生成
│
├─ build_rows() → 出力行構築（O=lon, P=lat 修正版）
├─ resample_polyline() → 20m等間隔＋30°折れ点保持
├─ haversine_m() → 距離計算
├─ bearing_deg() → 方位角
├─ turn_angle_deg() → 折れ角判定
├─ lerp_point() → 線形補間
└─ main() → 引数処理＋ブラウザ自動起動

---

# 🧾 更新履歴

| 日付 | 内容 |
|------|-------|
| 2025-11-05 | 初期版完成（O/P列の入れ替え） |
| 2025-11-05 | FLAG=2固定、20m等間隔＋折れ点保持実装 |
| 2025-11-05 | `.csv` 自動付加機能追加 |

---

# ✅ 確認済み動作

| 項目 | 結果 |
|------|-------|
| 地図クリック→CSV出力→route_mapper_simple で表示 | ✔ 正常 |
| O/P列の座標一致 | ✔ 正常 |
| trip_extractor.py との連携 | ✔ 一致・ヒット確認済み |
| TYPE/USE/FLAG/SPEED 値 | ✔ 正常固定値 |

---

# 💡 今後の拡張案

- UI に「間隔[m]」「折れ角[°]」の入力欄追加  
- 保存ファイル名に日付・時刻付加  
- GeoJSON などの出力追加  
- 作成した折れ線のドラッグ編集や途中点削除機能  

---
