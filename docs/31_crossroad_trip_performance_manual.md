# 31_crossroad_trip_performance.py マニュアル

## 1. 目的
交差点の「通過のしづらさ（減速・信号待ち・右左折の譲り合い等）」が反映されるように、交差点周辺の一定区間の所要時間から **交差点通過速度（独自指標）** を算出する。

※HCM等の一般的な交差点評価は「遅れ（delay）」が中心だが、本スクリプトでは可視化・比較のために、影響区間の平均速度として扱う。

## 2. 入力
- 第2スクリーニング済み CSV（様式1-2）
  - 1トリップの時系列点（緯度・経度・GPS時刻）を含む
- 交差点ファイル（crossroad_file）
  - 交差点中心座標と枝番（方向）情報を含む

`CONFIG` に trip_folder と crossroad_file をセットで指定する。

## 3. 出力
交差点ごとに性能CSVを出力する。

主要列：
- 流入枝番 / 流出枝番
- 計測距離(m)
- 所要時間(s)
- 交差点通過速度(km/h)

診断列（補間区間・最近接情報）：
- 計測区間_前(m) / 計測区間_後(m)
- 中心最近接距離(m)
- 中心最近接位置(m)
- 計測開始/終了位置(m)
- 計測開始/終了の経度・緯度・GPS時刻（補間）
- 最近接線分の前後点（生の点）と t(0-1)

## 4. 交差点通過速度（独自指標）の定義
### 4.1 計測区間（デフォルト）
交差点中心の最近接点を基準として、走行方向に
- 前：`MEASURE_PRE_M`（例：100m）
- 後：`MEASURE_POST_M`（例：10m）

の区間を「影響区間」とする。

### 4.2 所要時間の求め方（線形補間）
ETC2.0 等で点が粗い場合でも評価がブレないように、道なり累積距離を用いて
- 開始位置（中心基準 -100m）
- 終了位置（中心基準 +10m）
の通過時刻を、前後点の間で線形補間して求める。

### 4.3 速度の算出
距離を固定（`MEASURE_PRE_M + MEASURE_POST_M`）とし、所要時間で割って速度に換算する。

- 計測距離(m) = `MEASURE_PRE_M + MEASURE_POST_M`
- 交差点通過速度(km/h) = 計測距離(m) / 所要時間(s) × 3.6

※右左折で実走行距離が僅かに伸びても、距離は固定のため「右左折のペナルティ（減速・待ち）」が速度低下として出やすい。

## 5. 流入/流出枝番の推定
交差点中心に最も近い線分（2点間）を求め、その線分の
- 前点（上流側）を流入方向の参照点
- 後点（下流側）を流出方向の参照点
として、中心→参照点の方位角から最寄り枝番を選ぶ。

## 6. 除外条件
定義を固定するため、次のトリップは計測対象外として除外する。
- GPS時刻が欠損して補間できない
- 計測区間（前後距離）がトリップの範囲外に出る（開始位置 < 0 または 終了位置 > 全長）

除外件数は標準出力に表示する。

## 7. 変更履歴
- 2026-01-06: 「前後点数（±5点）」方式を廃止し、「前100m〜後10mの境界補間」方式へ変更。
