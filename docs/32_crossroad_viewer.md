# 32_crossroad_viewer
## 目的（何をする）
`31_crossroad_trip_performance.py` が出力した交差点性能 CSV を GUI で閲覧し、フィルタ・グラフ描画・Excel/画像出力を行う。現場確認用のビューア兼レポート整形ツール。
※31の仕様により「通過は全件出力・速度は未算出(空欄)が混在」するため、交通量と速度を分離して扱う。
## 位置づけ（分析フロー上のどこ）
- **ビューア**フェーズ（交差点性能）。
- PDF 用語の「ビューア」で、性能 CSV を使ったレポート作成・確認を担う。
## 入力
- 交差点性能 CSV（cp932, ヘッダ付き）: `{crossroad}_performance.csv`。
- 3ファイルが必要：
  - 交差点定義CSV（11_crossroad_sampler出力）
  - 交差点地図画像（jpg/png）
  - 性能CSV（31_crossroad_trip_performance出力）

### 運用モード
#### 1) バッチモード（推奨：複数交差点を一括処理）
`32_crossroad_viewer.py` の `BATCH_JOBS` に 3ファイル1組を複数記述して実行する。
- `BATCH_JOBS` が1件以上ある場合、ダイアログ無しで順次処理し、Excelレポートを自動生成して終了する。
- `output_xlsx` を省略した場合は、性能CSVの隣に `*_report.xlsx` を出力する。

#### 2) GUIモード（単発確認）
`BATCH_JOBS` が空の場合のみ、従来どおりダイアログで3ファイルを選択してGUI表示する。

### 重要：交通量と速度の扱い
31の出力には以下の列が追加される：
- `通過カウント`（交通量集計用。通過レコードは常に1）
- `速度算出可否`（1/0）
- `速度算出不可理由`（OK / OUT_OF_RANGE / TIME_MISSING / NO_SEGMENT）

ビューアは「交通量＝通過カウント合計」「速度集計＝速度算出可否=1のみ」で表示・集計する。
## 出力
- GUI 上でのグラフ表示に加え、Excel ファイルと PNG を生成可能。
- Excel には性能テーブルとグラフ画像を貼り付ける（openpyxl を使用）。

※作業フォルダ構成は `docs/05_work_folder_structure.md` を正とする。  
本スクリプトの出力先は `{PROJECT_ID}/31_交差点パフォーマンス/` で運用する。
## 実行方法
- 必要ライブラリ: PySide6, matplotlib, pandas, openpyxl。
- バッチ例: `python 32_crossroad_viewer.py`（`BATCH_JOBS` が埋まっていれば自動で一括実行）
- GUI例: `BATCH_JOBS=[]` にして `python 32_crossroad_viewer.py` → GUI 起動 → ダイアログで3ファイル選択
- カレンダーやリストで日付/枝を選択し、速度分布・通過件数などを確認。エクスポートボタンで Excel/画像を保存。
## 判定ロジック（重要なものだけ）
- pandas で CSV を読み込み、枝番号・方向・交通量（通過カウント）・速度（速度算出可否）を基にグラフを生成。
- 交通量（通過台数）は `通過カウント` の合計で集計する（速度欠損でも台数に含める）。
- 平均速度・速度ヒストグラムは `速度算出可否=1` の行のみを対象とする（速度空欄は速度集計から除外）。
- カレンダーウィジェットの選択日付に合わせてレコードをフィルタ。
- openpyxl でフォーマット済みワークシートを作り、matplotlib 画像を貼り付け。
## できること / できないこと（行政向けの注意）
- できること: 交差点性能の目視確認、日付/枝別のフィルタリング、Excel 添付用の静的レポート作成。
- できないこと: 新たな性能指標の計算、FLAG/距離閾値の変更、ブラウザ経由の共有。ビューアで見える値は 31 の出力に依存し、再計算は行わない。
  - 速度未算出（空欄）レコードは、交通量には含めるが、速度統計には含めない（仕様）。
## よくあるミス
- 必要ライブラリ未インストールで GUI 起動に失敗。
- 文字コードが cp932 以外の CSV を読み込んで文字化け。
- グラフ用フォント（メイリオ等）が環境に無く、図が崩れる。
## 関連スクリプト
- 前段: [docs/31_crossroad_trip_performance.md](./31_crossroad_trip_performance.md)。
- フロー全体: [docs/01_pipeline.md](./01_pipeline.md)
