# 33_branch_check（流入・流出枝判定ビューア）

## 1. このツールは何のためのもの？
31で作られる「`*_performance.csv`」には、各通過イベントごとに次のような情報が入っています。

- 流入枝番 / 流出枝番（枝判定結果）
- 流入角度 / 流出角度
- 角度差（枝の `dir_deg` とのズレ）
- 算出中心（最近接点）
- 計測開始・終了点（補間後）

ただし、枝判定は「角度の近さ」で決まるため、
交差点定義（11で作る Point CSV）が少しズレただけでも、枝番が入れ替わることがあります。

この33は、

> 枝判定が本当に意図通りになっているかを、地図上で目視確認する

ためのビューアです。

枝判定が怪しい場合は、
交差点定義ファイル（Point CSV）を作り直して、
31を再実行し、再度33で確認できます。

これにより「誤判定を放置しない」解析フローになります。

---

## 2. 入力
このツールは「交差点パフォーマンスCSV」を読みます。

- 入力：`*_performance.csv`
- 選択方法：
  - GUI起動時にファイル選択ダイアログ
  - または `--csv <path>` 指定
  - `--nogui` でも動作（HTMLを生成してブラウザ表示）
    （ただしGUIの詳細表示は使えません）

CSVは `cp932` / `shift_jis` / `utf-8` を順に試して読みます。

---

## 3. 起動時に内部でしていること（処理の流れ）

### 3.1 必須列の確認
入力CSVに次の列があるかチェックします（代表例）：

- 流入枝番 / 流出枝番
- 流入角度差 / 流出角度差
- 角度算出方式
- 計測距離、中心最近接距離
- 所要時間、計測開始/終了（補間）
- 交差点中心、算出中心

不足があれば、どの列が無いかをメッセージで出して止まります。

### 3.2 数値列の型をそろえる
角度や距離、所要時間などを数値に変換し、
変換できないものは `NaN` にします。

### 3.3 並び替え（見たいものが上に来るように）
一覧表では次の順で優先表示します。

1. 所要時間算出可否 = OK のもの
2. 遅れ時間(s) が大きいもの
3. 運行日

さらに最初の表示では「遅れ時間(s)」の降順ソートが入ります。

---

## 4. Point CSV（交差点定義）の扱い
このツールは、可能なら自動で Point CSV を探します。

探索場所（優先順の候補）：
- `<project>/11_交差点(Point)データ/<交差点名>.csv`
- `<performance.csvのあるフォルダ>/11_交差点(Point)データ/<交差点名>.csv`

見つかった場合：
- そこから中心座標（中心_緯度/経度など）を読みます
- 枝番 + 角度（`dir_deg` 等）を読み、地図上に「枝のレイ（放射線）」を描きます

見つからなかった場合（基準枝なしモード）：
- `performance.csv` の内容から「枝方向」を推定して描画します
  - 流入枝番ごとに、計測開始点（補間）から中心への方向を代表値化し
  - その方向に120mのレイを引きます

※ Point CSVがある場合は、Point CSV由来の枝を赤の破線として描き、
なければ推定枝を通常表示します。

---

## 5. 画面で可視化できること（ここが本体）
この33で見えるものは、1行（1通過イベント）ごとに以下です。

### 5.1 交差点中心（基準中心）
- 赤い丸で表示されます（Point CSVがあればその中心）

### 5.2 算出中心（最近接点）
- `performance.csv` に入っている「算出中心」を別マーカーで表示します
  - 交差点定義中心と、実際の軌跡上の中心がどれくらいズレているかが分かります

### 5.3 枝の放射線（枝定義）
- 枝番ごとに、中心から120mの放射線を引きます
- 枝ラベル（枝番号）を地図上に表示します
- 選択中イベントの
  - 流入枝番
  - 流出枝番
  だけをハイライト表示します（背景が変わる）

### 5.4 計測区間（開始点・終了点）
- `performance.csv` の「計測開始/終了（補間）」を地図上に点で表示します
- これにより「どの区間の所要時間を測っているか」が目で分かります

### 5.5 トリップの局所軌跡（生点）
- `performance.csv` に保存されている
  - point-4 … point+4
  - 【中央】点
  などの「中心前後の生点」を黒の破線で結び、点も表示します

※ つまり、枝判定に使った局所の軌跡が見えます。

### 5.6 IN / OUT の角度ベクトル
- 「流入角度deg」「流出角度deg」があれば
  - 算出中心から赤い太線を伸ばして表示します
  - ラベルとして
    - IN:枝○(Δ○°)
    - OUT:枝○(Δ○°)
    を表示します

ここでΔ（角度差）が大きい場合は、
枝判定が怪しいサインになります。

### 5.7 ネオンの玉アニメーション（軌跡追従）
- 黒破線の軌跡上を、ネオン色の玉がループ移動します
- 目視で「どっち向きの動きか」「どこで中心に近いか」を追いやすくします
- 残像（トレイル）も付けています

### 5.8 表示範囲は固定（200m四方）
- 交差点中心を基準に、200m四方に自動でフィットします
- 表示が毎回ブレないので比較がしやすいです

---

## 6. 一覧表で見えること（異常検知の入口）
一覧表には次の列を表示します（代表）：

- 運行日 / 曜日
- 種別 / 用途
- 所要時間算出可否
- 遅れ時間(s)
- 流入枝番 / 流出枝番
- 流入角度差 / 流出角度差

角度差が45°以上の行は背景を黄色にして目立たせます。
→ 「枝判定が怪しい候補」をすぐ拾えます。

---

## 7. このビューアを使った確認手順（おすすめ）
1. 33で `performance.csv` を開く
2. 一覧を「遅れ時間降順」のまま上から見る
3. 角度差が大きい（黄色）行を中心にクリックして地図で確認
4. 次の点をチェックする
   - IN/OUTの赤線が、想定した道路方向を向いているか
   - ハイライトされた枝番号が妥当か
   - 交差点中心と算出中心が不自然にズレていないか
   - 局所軌跡（黒破線）がどの道路に乗っているか
5. 誤判定が多い場合は、Point CSV（11）を作り直す
6. 31を再実行 → 33で再確認

この繰り返しで、
枝判定の精度を上げながら解析の透明性を確保できます。

---

## 8. `--nogui` モード（簡易表示）
`--nogui` の場合は、GUIを使わずにHTMLを出します。

- 先頭300行について
  - 計測開始 → 中心 → 計測終了 の線をオレンジで描く
  - 中心にマーカーを置く
- 出力HTML：`*_branch_check.html`

※ `nogui` は「ざっくり確認」用で、枝のハイライトや詳細パネルはGUIの方が強いです。
