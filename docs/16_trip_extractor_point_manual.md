# 16_trip_extractor_point.py マニュアル

## 1. 概要

`16_trip_extractor_point.py` は、ETC2.0 トリップデータから  
**「指定した交差点ポイントを通過するトリップ」だけを抽出**するツールです。

従来の `15_trip_extractor_route.py` が「ルート上を通るトリップ」を抽出していたのに対し、  
本スクリプトは `11_crossroad_sampler.py` で定義した **交差点の中心座標** を用いて判定します。

- 判定距離: 交差点中心から **20 m 以内（既定値）**
- 判定条件:
  - トリップ内の **いずれかの点が20m以内に入る**
  - または、**連続2点を結ぶ線分が20m以内を通過する**

いずれかを満たすトリップを **HIT** として抽出し、  
`2nd_...` 形式の CSV をトリップ単位で出力します。

---

## 2. 入力

### 2.1 トリップデータ

- 入力ディレクトリ: `DEFAULT_INPUT_DIR` または `--input-dir` で指定
- フォーマットは `15_trip_extractor_route.py` と同じ前提です。
- フラグ列（進入・退出フラグ）やトリップ番号列を使って、  
  スクリプト内部で自動的にトリップを分割します。

### 2.2 交差点データ（複数）

- `CROSSROAD_CSV_LIST` に、`11_crossroad_sampler.py` の出力 CSV を複数指定します。
- 交差点CSVの形式（ヘッダー例）:

  ```text
  crossroad_id,center_lon,center_lat,branch_no,branch_name,dir_deg
  ```

* 本スクリプトは、各CSVの **最初のデータ行の center_lon / center_lat** を
  交差点の中心座標として使用します。
* ファイル名（拡張子を除く部分）が、その交差点の識別子として
  出力ファイル名に埋め込まれます。

  例:

  * 交差点CSV: `crossroad01.csv`
  * 交差点名 (route_name): `crossroad01`

---

## 3. 出力

### 3.1 出力場所

* `DEFAULT_OUTPUT_DIR` または `--output-dir` で指定したディレクトリ配下に、
  HIT したトリップが **トリップ単位で CSV 出力**されます。

### 3.2 ファイル名フォーマット

`15_trip_extractor_route.py` と同じフォーマットを維持します。

```text
2nd_{crossroad_name}_{weekday_part}_ID{opid12}_{primary_date}_{trip_tag}_{etype_tag}_{fuse_tag}.csv
```

* `crossroad_name`

  * 交差点CSVのファイル名の stem（拡張子除去）
  * 例: `crossroad01.csv` → `crossroad01`

* `weekday_part`

  * トリップに含まれる運行日の曜日一覧（"SUN-MON-..."）

* `opid12`, `primary_date`, `trip_tag`, `etype_tag`, `fuse_tag`

  * いずれも `15_trip_extractor_route.py` と同じルールで決定されます。

### 出力例

```text
2nd_crossroad01_SAT_ID000000987654_20250315_t003_E02_F03.csv
```

---

## 4. HIT 判定ロジック

### 4.1 曜日フィルタ

* 設定値 `TARGET_WEEKDAYS` により、対象とする曜日を制限できます。
* トリップ内の各点について、対象曜日でないものは距離計算をスキップします。

### 4.2 点距離による判定

* 各トリップ内の点（緯度・経度）と交差点中心との距離を haversine で計算します。
* いずれかの点が `THRESH_M`（既定値 20m）以内に入った場合、`point_hits` を加算します。

### 4.3 線分距離による判定

* 点距離だけでは拾いきれないケース（例えば、点が粗くて交差点の直近を通過しているのに点が落ちていない場合）に対応するため、
  連続した2点を結んだ線分と交差点中心点との最短距離を評価します。
* 20m以内を通過すると判定された場合、`segment_hits` を加算します。

### 4.4 ヒットの閾値

* `point_hits + segment_hits >= MIN_HITS` となった時点で、そのトリップを **HIT** とみなし、
  抽出対象とします。
* `MIN_HITS` の既定値は `1` ですが、ノイズ対策のために任意に変更可能です。

---

## 5. パラメータ・設定

スクリプト冒頭で主な設定値を変更できます。

* `THRESH_M`

  * 交差点中心からの判定距離（m）
* `MIN_HITS`

  * HITとみなす最小ヒット数
* `TARGET_WEEKDAYS`

  * 抽出対象とする曜日
* `DRY_RUN`

  * `True` にするとファイル保存を行わず、ヒット件数のみ確認
* `RECURSIVE`

  * `True` にすると、入力ディレクトリ配下を再帰的に探索

---

## 6. 進捗表示

### 6.1 処理開始時

スクリプト実行時、最初に以下を表示します。

* 対象トリップCSVファイル数
* 対象交差点CSVファイル数
* 交差点名の一覧

例:

```text
Target trip CSV files: 123
Target crossroads    : 3
Crossroad list:
  - crossroad01
  - crossroad02
  - crossroad03
```

### 6.2 交差点ごとのログ

各交差点ごとに、次の情報が表示されます。

1. **開始行**

   ```text
   [CROSS] crossroad01  開始: 2025-03-15 10:23:45  対象CSV: 123 files
   ```

2. **進捗行（上書き更新）**

   ```text
   [crossroad01]  34% (42/123 files)  hits: 17  elapsed 00:03:21  eta 00:06:40
   ```

3. **終了行**

   ```text
   [CROSS] crossroad01  終了: 2025-03-15 10:31:02  所要時間: 00:07:17  HIT件数: 28
   ```

交差点ごとに空行を挟み、ブロックとして見やすく表示します。

### 6.3 全体サマリ

全ての交差点処理が完了すると、次のサマリを表示します。

```text
TOTAL 所要時間: 00:35:42
TOTAL HIT件数 : 213
```

---

## 7. 想定する用途

* 複数の交差点について、ETC2.0 トリップデータから
  **「その交差点を実際に通過したトリップだけ」を抽出**し、
  後続の交差点交通量分析や OD 分析に利用できます。
* `11_crossroad_sampler.py` で定義した交差点セットを変えることで、
  同じトリップデータに対して柔軟に交差点解析を行うことができます。

---

## 8. 注意点

* 判定距離 20m は GPS精度や地図との整合性を踏まえて調整してください。
* 線分判定は性能に影響するため、必要最小限の条件でのみ計算されるよう設計しています。
* 入力CSVの形式が想定と異なる場合、トリップの分割や日時のパースに失敗することがあります。
