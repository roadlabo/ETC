# 32_crossroad_report（交差点パフォーマンス レポート出力）

## 1. 32 の役割（31→32 の分担）

### 31 が担うこと（行レベルの性能データ作成）
`31_crossroad_trip_performance.py` は、交差点を「1 回の通過イベント」単位で分解し、
流入枝→流出枝（方向）ごとに以下を行単位で持つ性能 CSV を作成する。

- 通過方向（流入枝・流出枝）
- 所要時間(s)
- 閑散時所要時間(s)（T0）
- 遅れ時間(s) = 所要時間 - T0
- 所要時間算出可否 / 算出不可理由

### 32 が担うこと（集計・可視化・報告書化）
`32_crossroad_report.py` は、31 の性能 CSV を交通工学で説明可能な形に集約する。

- 日付・枝（方向）でフィルタ
- 交通量（通過件数）と遅れ（時間算出可能行のみ）を分離集計
- 方向別・時間帯別に傾向を可視化
- Excel レポート（openpyxl）として出力

**重要仕様**：31 は「通過は全件出力」する一方、所要時間未算出行が混在しうるため、32 では交通量と遅れを分離して扱う。

---

## 2. 方向別交通量の意味（交通工学的な価値）

32 の「方向別」は、主に **流入枝 × 流出枝**（直進・右折・左折の動き）を指す。

方向別交通量が重要な理由は次のとおり。

- 交差点性能は総量だけでなく「どの方向に需要が偏るか」で決まる。
- 信号現示、対向流、歩行者相の影響は方向ごとに異なる。
- ボトルネック方向を特定でき、対策単位（右折・直進・流入枝）で説明できる。

このため、方向別交通量は次のような改善検討に直結する。

- 右折需要集中：右折レーン延伸、右折相追加、右折禁止＋迂回誘導
- 直進需要集中：青時間配分見直し、時差式・オフセット調整
- 時間帯で方向需要が変動：TOD（Time of Day）制御の検討

---

## 3. 遅れ時間・総遅れ時間の定義

### 遅れ時間（本ツール定義）
32 は 31 出力の以下を利用する。

- `所要時間(s)`
- `閑散時所要時間(s)`（T0）
- `遅れ時間(s)` = 所要時間 - T0

交通工学的には、遅れは「自由走行（または閑散時）で不要なはずの余分時間」。
本ツールは理論値ではなく、同方向の実測から閑散時基準（T0）を置く点に実務的な強みがある。

### 総遅れ時間（Total Delay）
方向別の評価では、平均遅れだけでなく総遅れが重要。

- 総遅れ時間（秒） = 遅れ時間（秒/台） × 交通量（台）

方向別の総遅れを合算すると、交差点全体の損失時間を説明できる。
平均値のみよりも、利用者全体への影響（社会的損失）として政策説明しやすい。

---

## 4. 拡大推計（サンプル交通量 → 実交通量換算）

ETC2.0 データは装着率 100% ではないため、観測交通量はサンプル値。
実務では拡大係数を用いて実交通量へ換算する。

- 実交通量（推定） = 観測交通量 × 拡大係数
- 総遅れ（推定） = 総遅れ（観測） × 拡大係数

整理上は「遅れ/台」は維持し、台数側を拡大する考え方が自然。
方向別に拡大することで、社会的損失を現実規模で示せる。

---

## 5. 費用便益分析（B/C）への接続

32 の出力は、時間短縮便益の算定素材として利用できる。

- 便益（円/年） ≒ 年間総遅れ削減（台・時/年） × 時間価値（円/台・時）

方向別で評価できる利点。

- 特定方向だけに効く施策（右折レーン延伸、現示変更）の効果を定量化しやすい
- ある方向の改善と他方向の悪化（相殺）を可視化しやすい
- EBPM 資料として、施策の効き方を説明しやすい

---

## 6. 時間帯別分析の価値

交差点性能は一日を通じて一定ではない。時間帯別に切り分けることで次が可能になる。

- ピーク時間・混雑方向の特定
- 朝夕で異なる方向需要の把握
- TOD 制御、現示配分、協調制御の検討
- 便益算定の精度向上（平均化による過大/過小評価の抑制）

時間帯別に、

- 交通量（台）
- 平均遅れ（秒/台）
- 総遅れ（台・秒）

を示すことが、改善計画・説明資料の説得力につながる。

---

## 7. ツール仕様（入力 3 点セット / 交通量と遅れ分離 / 実行モード）

## 入力
- 交差点定義 CSV（11_crossroad_sampler 出力）
- 交差点地図画像（jpg/png）
- 性能 CSV（31_crossroad_trip_performance 出力, cp932）

### 列対応（31 最新ヘッダを列名参照）
- 距離/時間: `計測距離(m)` / `所要時間(s)` / `閑散時所要時間(s)` / `遅れ時間(s)`
- 可否: `所要時間算出可否` / `所要時間算出不可理由`
- 時間帯ヒストグラム: `計測開始_GPS時刻(補間)`（優先）/ `算出中心_GPS時刻`（フォールバック）

### 交通量と遅れの分離ルール（重要）
- 交通量：通過判定 OK の行数（所要時間欠損でも台数に含める）
- 遅れ統計：`所要時間算出可否=1` の行のみ

この設計により、需要（台数）を欠損で落とさず、遅れ評価は算出可能データに限定できる。

## 実行モード
### 1) バッチモード（推奨）
`BATCH_JOBS` に 3 ファイル 1 組を複数設定して実行。

- `BATCH_JOBS` が 1 件以上でダイアログなし一括処理
- `output_xlsx` 省略時は性能 CSV 隣に `*_report.xlsx` 出力

### 2) GUI モード（単発確認）
`BATCH_JOBS=[]` のときのみダイアログ選択で起動。

---

## 8. 出力（Excel/PNG）とレポートの読み方

## 出力物
- Excel レポート（`*_report.xlsx`）
- グラフ画像（PNG）
- GUI 上の確認画面

Excel には性能テーブルとグラフ画像を貼り付ける（openpyxl）。

## 読み方（実務向け）
1. **方向別交通量**：需要の偏りと主要動線を把握
2. **方向別平均遅れ**：運用上の問題方向を把握
3. **方向別総遅れ**：社会的損失の大きい方向を特定
4. **時間帯別比較**：ピーク発生時刻と施策対象時間帯を決定

---

## 実行方法
- 必要ライブラリ: PySide6, matplotlib, pandas, openpyxl
- バッチ例: `python 32_crossroad_report.py`（`BATCH_JOBS` 設定済み）
- GUI例: `BATCH_JOBS=[]` にして `python 32_crossroad_report.py`

---

## できること / できないこと

- できること：
  - 方向別・時間帯別の交通量/遅れ確認
  - 日付/枝フィルタ
  - Excel 添付用の静的レポート化

- できないこと：
  - 31 側ロジックの再計算
  - FLAG/距離閾値の変更
  - ブラウザ経由共有

※所要時間未算出行は、交通量には含めるが遅れ統計には含めない（仕様）。

---

## 関連ドキュメント
- 前段: [docs/31_crossroad_trip_performance.md](./31_crossroad_trip_performance.md)
- フロー全体: [docs/01_pipeline.md](./01_pipeline.md)
- 作業フォルダ構成: [docs/05_work_folder_structure.md](./05_work_folder_structure.md)
