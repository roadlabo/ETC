# 05_route_mapper_simple

## これは何をするツール？
CSV に入っている走行軌跡（緯度・経度の点列）を地図に描き、同時に速度の推移もグラフで確認できる「トリップ確認用ビューア」です。
ファイルを選ぶと、地図と速度グラフがすぐ更新されます。

## 画面でできること（見えるもの）
この UI は大きく **左（ファイル一覧）／右（地図＋速度グラフ）** に分かれます。

### 左側：ファイル選択と CSV の概要表示
- フォルダ選択（CSV が入ったフォルダを指定）
- CSV ファイル一覧（クリックで切り替え）
- 選択中 CSV の情報
  - 点数（有効な座標点の数）
  - GPS 時刻の範囲（最小～最大）
  - 種別（軽自動車などの表示に置き換え）
  - 用途（乗用などの表示に置き換え）

### 右側：地図（上）＋速度グラフ（下）
- 地図：軌跡を線と点で表示
- 速度グラフ：速度（km/h）の推移を表示
  - GPS 時刻が解釈できれば時間軸
  - できなければ行番号軸

## 入力（CSV）で前提としている列
このツールは **列名ではなく列番号（0 始まり）** で読み取ります。
CSV の列順が違うと正しく表示できません。

- 緯度: 14 列目（index=14）
- 経度: 15 列目（index=15）
- FLAG: 12 列目（index=12）
- 種別: 4 列目（index=4）
- 用途: 5 列目（index=5）
- GPS 時刻: 6 列目（index=6）
- 速度: 18 列目（index=18）

## 読み込み時に内部でしていること（重要）
### 1) CSV を必要列だけ読み込む
上の列だけを pandas で読み込み、数値として解釈できないものは欠損扱いにします。

### 2) 緯度・経度の入れ替わり救済
緯度と経度が逆に入っていそうな場合（例：lon が 20～50、lat が 120～150 に多く入る）に、lat/lon を入れ替えて救済します。

### 3) 日本国内っぽい座標だけに絞る
- 経度：120～150
- 緯度：20～50

この範囲から外れる点は除外します（表示の暴走を防ぐため）。

### 4) FLAG で「線の区切り」を作る
地図上の軌跡は、点列を 1 本の線で全部つなぐのではなく、**FLAG のルールで分割して複数の線（segments）** にします。

区切り条件は次の通りです。
- **直前の点が FLAG=1（終点）** だったら、次の点から新しい線を開始
- **現在の点が FLAG=0（始点）** だったら、その点から新しい線を開始

## 地図の表示ルール（S/G/通過点）
地図には次のように描き分けます。

- FLAG=0：Start（S）マーカー
- FLAG=1：Goal（G）マーカー
- それ以外：通過点（小さな点）

さらに、各点にツールチップを付けています。
- GPS 時刻（読み取れた場合は `YYYY/MM/DD hh:mm:ss` 形式）
- 速度（km/h、なければ `-`）

補足：線（segments）は黒い破線で表示します。

## “動く球”のアニメーション（生データ順の雰囲気確認）
地図上では、点列（生データ順）に沿ってネオン風の小さな球が走るアニメーションを重ねています。
これは「この CSV がだいたいどんな軌跡か」を目で追いやすくするための演出です（解析ロジックには影響しません）。

## 速度グラフの表示ルール
- 速度列を数値にできるところだけ使って描画します
- GPS 時刻がある程度読める場合は時間軸で速度推移を描きます
- 時刻がうまく読めない場合は行番号（index）を横軸にして速度推移を描きます

## オフライン時の挙動
起動時にインターネットへ接続できない場合、通知を出します。
（地図タイルが取得できないため、地図が白っぽく見えることがあります）

## 出力ファイルについて
- 通常 UI モード：基本的に画面内（Qt WebEngine）で地図表示します（ブラウザの別タブを開かない設計）
- `--nogui` モード：フォルダ（または CSV）から 1 件読み、`(stem)_route_map.html` を作ってブラウザで開きます

## 使い方（UI モード）
```bash
python src/05_route_mapper_simple.py
```

1. CSV が入ったフォルダを選択
2. 左の一覧で CSV をクリック
3. 地図と速度グラフが更新

## 使い方（--nogui モード）
GUI を使わず、HTML を作ってブラウザで開きたい場合：

フォルダを指定して実行（フォルダ内の先頭 CSV を使います）
```bash
python src/05_route_mapper_simple.py --nogui --folder "D:\...\1st_output"
```

CSV ファイルを直接指定して実行（引数の解釈は実装に依存）
```bash
python src/05_route_mapper_simple.py --nogui "D:\...\trip.csv"
```

## よくあるつまずき
- 列順が違う CSV を読んでいる
  → 緯度経度が取れず点数 0 になりやすいです（このツールは列番号固定です）。
- `leaflet/` が見つからない
  → 地図表示に失敗します。`src/leaflet/` が配置されているか確認してください。
- オフライン環境
  → 地図タイルが取れず、背景が白っぽくなることがあります。
